<!--
Soulframe Tracker — Single-file-V.2.0 
Author: Gs_DontFall  
Date: 2025-11-23 | Version: 0.2.0
---------------------Credits:--------------------------
- Puxtril: all Metadata, Warframe-Exporter, and his time.
- Texts/Lore: Avakot.org
- Image references (weapons&Pacts, factions, enemies): Avakot.org
- Game assets & trademarks © Digital Extremes Ltd.
----------Fan-made project, not affiliated.------------
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soulframe Tracker</title>

  <!-- Partage social -->
  <meta property="og:title" content="Soulframe Tracker" />
  <meta property="og:description" content="Suivez vos statistiques Soulframe - Armes, capacités, ennemis et bien plus encore" />
  <meta property="og:image" content="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/image%20app%20discord.png" />
  <meta property="og:url" content="https://soulframe-tracker.vercel.app" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Soulframe Tracker" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Soulframe Tracker" />
  <meta name="twitter:description" content="Suivez vos statistiques Soulframe" />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/image%20app%20discord.png" />

  <!-- Librairies -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Styles globaux -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;600;700&display=swap');

    /* === STYLES DE BASE === */
    body {
      background-image:
        linear-gradient(to bottom right, rgba(13,13,11,.8), rgba(18,18,16,.8), rgba(10,10,8,.8)),
        url('https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/desktop-wallpaper1.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      margin: 0;
      min-height: 100vh;
      font-family: 'Merriweather', serif;
      color-scheme: dark;
    }

    /* === BOUTON MUSIQUE === */
    .music-control {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      width: auto;
      height: auto;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      gap: 6px;
    }

    .music-icon-img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      pointer-events: auto;
      cursor: pointer;
      transition: transform .35s ease, filter .3s ease, opacity .3s ease;
      filter: none;
      opacity: 1;
    }

    .music-control:hover .music-icon-img { transform: scale(1.12); }
    .music-control.muted .music-icon-img { filter: grayscale(35%) brightness(0.9) opacity(0.85); }

    .music-volume-wrapper {
      width: 65px;
    }

    .music-volume-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: rgba(120, 85, 40, 0.5);
      outline: none;
    }

    .music-volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fbbf24;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.7);
    }

    .music-volume-slider::-moz-range-thumb {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fbbf24;
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0,0,0,0.7);
      border: none;
    }

    /* === TOOLTIPS === */
    .relative.group .absolute, .group .absolute { z-index: 99999 !important; }
    table, td, th, .bg-gradient-to-br { position: relative; z-index: 1 !important; }
    .absolute.z-\[9999\] { z-index: 99999 !important; }
    .group:hover .absolute { z-index: 999999 !important; }
    #weapons .overflow-auto { overflow: visible !important; }
    #weapons .group:hover .absolute, #weapons .group .absolute { z-index: 999999 !important; pointer-events: none; }

    #subboss .overflow-auto, #subboss table, #subboss td, #subboss th{
      overflow: visible !important; position: relative !important; z-index: 1 !important;
    }
    #subboss .group:hover .absolute, #subboss .group .absolute{
      z-index: 999999 !important; pointer-events: none;
    }

    /* === LORE ROTATIF === */
    @keyframes fadeSwap{
      0%{opacity:0; transform:translateY(6px)}
      12%{opacity:1; transform:translateY(0)}
      88%{opacity:1; transform:translateY(0)}
      100%{opacity:0; transform:translateY(-6px)}
    }
    .lore-anim{ animation: fadeSwap 20s ease-in-out infinite; }
    .lore-panel:hover .lore-anim{ animation-play-state: paused; }
    @media (prefers-reduced-motion: reduce){
      .lore-anim{ animation-duration:.01ms; animation-iteration-count:1; }
    }

    /* === TOASTS === */
    @keyframes fadeInOut{
      0%{opacity:0; transform:translateY(-4px)}
      10%{opacity:1; transform:translateY(0)}
      90%{opacity:1; transform:translateY(0)}
      100%{opacity:0; transform:translateY(-4px)}
    }
    .animate-fade-in-out{ animation: fadeInOut 2.8s ease-in-out; }

    /* === PILE DE VUES === */
    .page-stack{ position: relative; min-height: 60vh; }
    .view{ position: static; opacity: 1; transform: none; pointer-events: auto; }
    .view.hidden{ display: none; }

    /* === VOILE DE TRANSITION === */
    .transition-veil{
      position: fixed; inset: 0; z-index: 9999;
      pointer-events: none; display: grid; place-items: center;
      background: rgba(41,28,17,1);
      animation: veilFade 2600ms ease forwards;
      will-change: opacity, transform; backface-visibility: hidden; transform: translateZ(0);
    }

    .transition-veil::after{ content: none !important; }

    .transition-logo{
      width: clamp(120px, 18vw, 220px);
      height: clamp(120px, 18vw, 220px);
      display: grid; place-items: center;
      background: transparent; overflow: visible; isolation: isolate;
      transform: scale(.96);
      animation: logoPop 900ms ease forwards;
    }
    .transition-logo img{
      width: 100%; height: 100%; object-fit: contain;
      image-rendering: auto; filter: none; background: transparent; mix-blend-mode: normal;
    }
    @keyframes veilFade{
      0%{opacity:0; transform:scale(1)}
      12%{opacity:1; transform:scale(1)}
      88%{opacity:1; transform:scale(1)}
      100%{opacity:0; transform:scale(1)}
    }
    @keyframes logoPop{
      0%{opacity:.85; transform:scale(1.96)}
      50%{opacity:1; transform:scale(2)}
      100%{opacity:.95; transform:scale(1.985)}
    }

    /* === ZOOM IMAGES === */
    .zoomable-image {
      cursor: zoom-in;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .image-container, 
    .weapon-image-container,
    .enemy-image-container,
    .boss-image-container {
      overflow: visible !important;
      position: relative;
    }

    .image-zoom-tooltip {
      position: fixed;
      z-index: 999999;
      background: #0b0a08;
      border: 2px solid #d4af37;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
      max-width: 320px;
      max-height: 350px;
      pointer-events: none;
      font-family: 'Merriweather', serif;
      backdrop-filter: blur(10px);
    }

    .image-zoom-tooltip img {
      display: block;
      object-fit: contain;
      border-radius: 4px;
    }

    /* === ANIMATION DES MOTES === */
    .mote-float {
      position: absolute;
      color: #ffdf6e;
      font-weight: bold;
      pointer-events: none;
      animation: moteFloatUp 0.9s ease-out forwards;
      z-index: 999999;
    }

    @keyframes moteFloatUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-40px); }
    }
  </style>
</head>

<body>
  <!-- Audio de fond -->
  <audio id="backgroundMusic" loop aria-hidden="true">
    <source src="https://cdn.jsdelivr.net/gh/generalshark/app-soulframe-v1/docs/TeaserSiteBackGroundLoop.mp3" type="audio/mpeg">
  </audio>

  <!-- Racine React -->
  <div id="root"></div>

  <!-- Bouton musique -->
  <div class="music-control" id="musicControl" title="Musique de fond">
    <img
      class="music-icon-img"
      src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/note_de_music_aura.png"
      alt="Music"
    />
    <div class="music-volume-wrapper">
      <input
        id="musicVolume"
        type="range"
        min="0"
        max="100"
        step="1"
        class="music-volume-slider"
      />
    </div>
  </div>

  <!-- Module de statistiques -->
  <script src="./soulframe-stats-module.js"></script>
  <script>
    // Vérifier que le module est bien chargé
    if (!window.SoulframeStats) {
      window.SoulframeStats = {
        getTimerDisplay: () => "Module loading...",
        loadFromStorage: () => {},
        initializeTimer: () => {},
        trackSession: () => {},
        exportStatistics: () => alert("Module non chargé"),
        renderStatisticsUI: () => "<div>Module de statistiques en cours de chargement...</div>"
      };
    }
  </script>

  <!-- App React -->
  <script type="text/babel">
    // =============================================================================
    // CONFIGURATION GLOBALE DES MOTES
    // =============================================================================
    const MOTE_CONFIG = {
      SIZE: 32,                  // Taille visible de la mote en pixels
      MIN_TRAVEL_DURATION: 12000, // Durée minimale d'un trajet (12 secondes)
      MAX_TRAVEL_DURATION: 32000, // Durée maximale d'un trajet (32 secondes)
      MIN_PAUSE: 145000,          // Pause minimale avant nouveau vol (145 secondes)
      MAX_PAUSE: 900000,         // Pause maximale (900 secondes)
      INITIAL_MIN_DELAY: 52000,   // Délai minimum avant 1ère apparition (52 secondes)
      INITIAL_MAX_DELAY: 227000,  // Délai maximum avant 1ère apparition (227 secondes)
      ZIG_BASE_HZ: 1.8,          // Fréquence de base du zigzag
      ZIG_HZ_MIN: 0.6,           // Fréquence minimale du zigzag
      ZIG_HZ_MAX: 3.2,           // Fréquence maximale du zigzag
      ZIG_AMP: 15,               // Amplitude du zigzag en pixels
      LINK_SPEED_TO_ZIG: true,   // Lier vitesse moyenne au zigzag
      ZIG_VARIATION_STRENGTH: 0.6, // Force de variation de fréquence
      ZIG_VARIATION_SPEED: 7.5,  // Vitesse de variation de fréquence
      AMP_VARIATION_STRENGTH: 0.3, // Force de variation d'amplitude
      AMP_VARIATION_SPEED: 2.0   // Vitesse de variation d'amplitude
    };

    // =============================================================================
    // COMPOSANT MOTE (PARTICULES FLOTTANTES)
    // =============================================================================
    const MoteInstance = ({ index = 0, total = 1 }) => {
      const [style, setStyle] = React.useState({
        position: "absolute",
        left: 0,
        top: 0,
        width: `${MOTE_CONFIG.SIZE}px`,
        height: `${MOTE_CONFIG.SIZE}px`,
        opacity: 0,
        transform: "translate3d(-9999px,-9999px,0)",
        pointerEvents: "auto",
        cursor: "pointer",
      });

      const travelRef = React.useRef(null);
      const frameRef = React.useRef(null);

      React.useEffect(() => {
        const edgeFadePx = 300;
        const fadeMinOpacity = 0.1;

        // Génère un nombre pseudo-aléatoire basé sur l'index
        const randFromIndex = (offset = 0) => {
          const base = Math.sin(index * 137.42 + offset) * 10000;
          return base - Math.floor(base);
        };

        // Définit un nouveau trajet pour la mote
        const pickNewTravel = () => {
          const w = window.innerWidth || 1920;
          const h = window.innerHeight || 1080;
          const moteSize = MOTE_CONFIG.SIZE;

          // Choisir un axe aléatoire (0 = horizontal, 1 = vertical)
          const axis = (index + Math.random() * 2 > 1.5) ? 0 : 1;

          // Durée de base du trajet
          const baseDuration = MOTE_CONFIG.MIN_TRAVEL_DURATION +
            randFromIndex(1.23) * (MOTE_CONFIG.MAX_TRAVEL_DURATION - MOTE_CONFIG.MIN_TRAVEL_DURATION);

          // Fréquence de base du zigzag
          const zigRange = MOTE_CONFIG.ZIG_HZ_MAX - MOTE_CONFIG.ZIG_HZ_MIN;
          const baseZigHz = MOTE_CONFIG.ZIG_HZ_MIN + randFromIndex(2.34) * (zigRange > 0 ? zigRange : 0);

          // Lier la vitesse moyenne à la fréquence si configuré
          let duration = baseDuration;
          if (MOTE_CONFIG.LINK_SPEED_TO_ZIG && MOTE_CONFIG.ZIG_BASE_HZ > 0) {
            const ratio = baseZigHz / MOTE_CONFIG.ZIG_BASE_HZ;
            duration = baseDuration / Math.max(ratio, 0.2);
          }

          const pause = MOTE_CONFIG.MIN_PAUSE +
            randFromIndex(4.56) * (MOTE_CONFIG.MAX_PAUSE - MOTE_CONFIG.MIN_PAUSE);

          // Phase aléatoire pour la variation de fréquence
          const zigVarPhase = randFromIndex(7.89) * Math.PI * 2;

          if (axis === 0) {
            // Trajet horizontal
            const yMin = h * 0.05;
            const yMax = h * 0.95 - moteSize;
            const baseY = yMin + randFromIndex(3.21) * (yMax - yMin);

            const fromLeft = randFromIndex(5.43) < 0.5;
            const fromX = fromLeft ? -moteSize : w;
            const toX = fromLeft ? w : -moteSize;

            travelRef.current = {
              phase: "move",
              axis,
              startTime: performance.now(),
              duration,
              pause,
              fromX,
              toX,
              baseY,
              moteSize,
              baseZigHz,
              zigVarPhase,
            };
          } else {
            // Trajet vertical
            const xMin = w * 0.02;
            const xMax = w * 0.98 - moteSize;
            const baseX = xMin + randFromIndex(6.54) * (xMax - xMin);

            const fromBottom = randFromIndex(8.76) < 0.5;
            const fromY = fromBottom ? h : -moteSize;
            const toY = fromBottom ? -moteSize : h;

            travelRef.current = {
              phase: "move",
              axis,
              startTime: performance.now(),
              duration,
              pause,
              fromY,
              toY,
              baseX,
              moteSize,
              baseZigHz,
              zigVarPhase,
            };
          }
        };

        // Fonction d'interpolation pour mouvements fluides
        const smoothstep = (u) => u * u * (3 - 2 * u);

        // Boucle d'animation principale
        const step = () => {
          const now = performance.now();
          let tr = travelRef.current;

          // Si pas encore d'état → Pause initiale
          if (!tr) {
            const baseInitial = MOTE_CONFIG.INITIAL_MIN_DELAY +
              randFromIndex(9.87) * (MOTE_CONFIG.INITIAL_MAX_DELAY - MOTE_CONFIG.INITIAL_MIN_DELAY);

            const stagger = index * 5000;

            travelRef.current = {
              phase: "pause",
              nextStart: now + baseInitial + stagger,
            };
            tr = travelRef.current;
          }

          // PHASE PAUSE
          if (tr.phase === "pause") {
            if (now >= tr.nextStart) {
              pickNewTravel();
              tr = travelRef.current;
            } else {
              setStyle(prev => ({ ...prev, opacity: 0 }));
              frameRef.current = requestAnimationFrame(step);
              return;
            }
          }

          // PHASE MOVE (trajet)
          if (tr.phase === "move") {
            const tRaw = (now - tr.startTime) / tr.duration;
            const t = Math.max(0, Math.min(1, tRaw)); // clamp entre 0 et 1
            const s = smoothstep(t);

            const w = window.innerWidth || 1920;
            const h = window.innerHeight || 1080;
            const moteSize = tr.moteSize || MOTE_CONFIG.SIZE;

            const arc_h = 150;

            // Variation d'amplitude
            const baseAmp = MOTE_CONFIG.ZIG_AMP;
            const ampMod = MOTE_CONFIG.AMP_VARIATION_STRENGTH *
              Math.sin(2 * Math.PI * MOTE_CONFIG.AMP_VARIATION_SPEED * t + index);

            const zig_amp = baseAmp * (1 + ampMod);

            // Variation de fréquence
            const freqMod = MOTE_CONFIG.ZIG_VARIATION_STRENGTH *
              Math.sin(2 * Math.PI * MOTE_CONFIG.ZIG_VARIATION_SPEED * t + (tr.zigVarPhase || 0));

            const zig_hz = tr.baseZigHz * (1 + freqMod);

            const drift_amp = 10;

            let x, y;

            if (tr.axis === 0) {
              // Trajet HORIZONTAL
              const xPos = tr.fromX + (tr.toX - tr.fromX) * s;

              const arc = -arc_h * Math.sin(Math.PI * t);
              const zig = zig_amp * Math.sin(2 * Math.PI * zig_hz * t + index + 1);
              const drf = drift_amp * Math.sin(2 * Math.PI * 0.23 * t + 0.7);

              const yBase = tr.baseY;
              const yMin = h * 0.02;
              const yMax = h * 0.98 - moteSize;

              const yPos = Math.max(yMin, Math.min(yMax, yBase + arc + zig + drf));

              x = xPos;
              y = yPos;
            } else {
              // Trajet VERTICAL
              const yPos = tr.fromY + (tr.toY - tr.fromY) * s;

              const arc = -arc_h * Math.sin(Math.PI * t);
              const zig = zig_amp * Math.sin(2 * Math.PI * zig_hz * t + index + 0.6);
              const drf = drift_amp * Math.sin(2 * Math.PI * 0.21 * t + 0.4);

              const xBase = tr.baseX;
              const xMin = w * 0.01;
              const xMax = w * 0.99 - moteSize;

              const xPos = Math.max(xMin, Math.min(xMax, xBase + arc + zig + drf));

              x = xPos;
              y = yPos;
            }

            // FADE AUX BORDS de l'écran
            let dist;
            if (tr.axis === 0) {
              dist = Math.min(x, w - moteSize - x);
            } else {
              dist = Math.min(y, h - moteSize - y);
            }

            let u = Math.max(0, Math.min(1, dist / edgeFadePx));
            const opacity = fadeMinOpacity + (1 - fadeMinOpacity) * smoothstep(u);

            setStyle(prev => ({
              ...prev,
              transform: `translate3d(${x}px, ${y}px, 0)`,
              opacity,
            }));

            // FIN DU TRAJET
            if (tRaw >= 1) {
              const nextPause = MOTE_CONFIG.MIN_PAUSE +
                randFromIndex(4.56) * (MOTE_CONFIG.MAX_PAUSE - MOTE_CONFIG.MIN_PAUSE);

              travelRef.current = {
                phase: "pause",
                nextStart: now + nextPause,
              };

              frameRef.current = requestAnimationFrame(step);
              return;
            }
          }

          // Boucle d'animation
          frameRef.current = requestAnimationFrame(step);
        };

        frameRef.current = requestAnimationFrame(step);

        return () => {
          if (frameRef.current) cancelAnimationFrame(frameRef.current);
        };
      }, [index, total]);

      return (
        <div className="pointer-events-none fixed inset-0 z-60">
          <img
            src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/mote1.png"
            style={style}
            className="mote-img"
            onClick={(e) => {
              e.stopPropagation();
              e.preventDefault();

              // Forcer une fin de trajet + longue pause
              const now = performance.now();
              const pauseAfterClick = MOTE_CONFIG.MIN_PAUSE +
                Math.random() * (MOTE_CONFIG.MAX_PAUSE - MOTE_CONFIG.MIN_PAUSE);

              travelRef.current = {
                phase: "pause",
                nextStart: now + pauseAfterClick,
              };

              // Disparition immédiate
              setStyle(prev => ({
                ...prev,
                opacity: 0,
                transform: "translate3d(-9999px,-9999px,0)",
              }));

              // Effet visuel "+1"
              const float = document.createElement("div");
              float.className = "mote-float";
              float.textContent = "+1";
              float.style.left = `${e.clientX}px`;
              float.style.top = `${e.clientY}px`;
              document.body.appendChild(float);
              setTimeout(() => float.remove(), 900);

              // Incrémenter le score global
              if (window.__onMoteClick) {
                window.__onMoteClick();
              }
            }}
          />
        </div>
      );
    };

    // =============================================================================
    // CONTENEUR DES MOTES
    // =============================================================================
    const WanderingMote = ({ count = 1 }) => {
      const items = [];
      for (let i = 0; i < count; i++) {
        items.push(<MoteInstance key={i} index={i} total={count} />);
      }
      return <React.Fragment>{items}</React.Fragment>;
    };

    // =============================================================================
    // PARTICULES DE FOND
    // =============================================================================
    const BackgroundParticles = () => {
      const canvasRef = React.useRef(null);
      const animationRef = React.useRef(null);
      const particlesRef = React.useRef([]);
      const lastTimeRef = React.useRef(null);
      const mouseRef = React.useRef({ x: null, y: null });

      // Configuration des particules
      const PARTICLE_COUNT = 300;
      const TRAVEL_TIMES = [20, 30, 45, 60];
      const MIN_RADIUS = 1;
      const MAX_RADIUS = 3;
      const MIN_ALPHA = 0.02;
      const MAX_ALPHA = 0.42;
      const MOUSE_INFLUENCE_RADIUS = 320;
      const MOUSE_FORCE = 110;
      const MOUSE_KICK = 70;
      const MAX_SPEED = 220;

      // Création d'une particule
      const createParticle = React.useCallback((canvas, fromEdge = true) => {
        const width = canvas.width;
        const height = canvas.height;

        const radius = MIN_RADIUS + Math.random() * (MAX_RADIUS - MIN_RADIUS);
        const alpha = MIN_ALPHA + Math.random() * (MAX_ALPHA - MIN_ALPHA);
        const travelTime = TRAVEL_TIMES[Math.floor(Math.random() * TRAVEL_TIMES.length)];

        // Bords possibles avec préférence pour la droite
        const edges = ["right", "right", "left", "bottom"];
        const edge = edges[Math.floor(Math.random() * edges.length)];

        let startX, startY, dirX, dirY, distance;

        if (edge === "right") {
          startX = width + radius;
          startY = Math.random() * height;
          dirX = -1;
          dirY = 0;
          distance = width + 2 * radius;
        } else if (edge === "left") {
          startX = -radius;
          startY = Math.random() * height;
          dirX = 1;
          dirY = 0;
          distance = width + 2 * radius;
        } else {
          // bottom
          startX = Math.random() * width;
          startY = height + radius;
          dirX = 0;
          dirY = -1;
          distance = height + 2 * radius;
        }

        const norm = Math.sqrt(dirX * dirX + dirY * dirY) || 1;
        const baseSpeed = (distance / travelTime) * 0.7; // px/sec

        let vx = (dirX / norm) * baseSpeed;
        let vy = (dirY / norm) * baseSpeed;

        let x = startX;
        let y = startY;

        if (!fromEdge) {
          // Particule déjà en plein trajet
          const progress = Math.random();
          x = startX + (dirX / norm) * distance * progress;
          y = startY + (dirY / norm) * distance * progress;
        }

        return { x, y, vx, vy, radius, alpha };
      }, []);

      React.useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;

        const ctx = canvas.getContext("2d");

        // Redimensionnement du canvas
        const resize = () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          particlesRef.current = [];
          for (let i = 0; i < PARTICLE_COUNT; i++) {
            particlesRef.current.push(createParticle(canvas, false));
          }
        };

        resize();
        window.addEventListener("resize", resize);

        // Gestion des événements souris
        const handleMouseMove = (e) => {
          mouseRef.current.x = e.clientX;
          mouseRef.current.y = e.clientY;
        };

        const handleMouseLeave = () => {
          mouseRef.current.x = null;
          mouseRef.current.y = null;
        };

        window.addEventListener("mousemove", handleMouseMove);
        window.addEventListener("mouseleave", handleMouseLeave);

        // Boucle d'animation
        const animate = (timestamp) => {
          if (lastTimeRef.current == null) {
            lastTimeRef.current = timestamp;
          }
          let dt = (timestamp - lastTimeRef.current) / 1000;
          lastTimeRef.current = timestamp;

          // Éviter les sauts si l'onglet était inactif
          if (dt > 0.25) {
            dt = 0.016;
          }

          const { width, height } = canvas;
          ctx.clearRect(0, 0, width, height);

          const particles = particlesRef.current;
          const mouse = mouseRef.current;

          for (let i = 0; i < particles.length; i++) {
            const p = particles[i];

            // Répulsion par la souris
            if (mouse.x != null && mouse.y != null) {
              const dx = p.x - mouse.x;
              const dy = p.y - mouse.y;
              const dist = Math.sqrt(dx * dx + dy * dy) || 1;

              if (dist < MOUSE_INFLUENCE_RADIUS) {
                let influence = 1 - dist / MOUSE_INFLUENCE_RADIUS;
                influence = influence * influence;

                const nx = dx / dist;
                const ny = dy / dist;

                const accel = influence * MOUSE_FORCE;
                const kick = influence * MOUSE_KICK;

                p.vx += nx * accel * dt;
                p.vy += ny * accel * dt;
                p.x += nx * kick * dt;
                p.y += ny * kick * dt;
              }
            }

            // Limitation de vitesse
            const speed = Math.hypot(p.vx, p.vy);
            if (speed > MAX_SPEED) {
              const k = MAX_SPEED / speed;
              p.vx *= k;
              p.vy *= k;
            }

            // Mouvement
            p.x += p.vx * dt;
            p.y += p.vy * dt;

            const margin = 20;

            // Respawn si sortie de l'écran
            if (p.x < -margin - p.radius || p.x > width + margin + p.radius ||
                p.y < -margin - p.radius || p.y > height + margin + p.radius) {
              particles[i] = createParticle(canvas, true);
              continue;
            }

            // Dessin de la particule
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
            ctx.fill();
          }

          animationRef.current = requestAnimationFrame(animate);
        };

        animationRef.current = requestAnimationFrame(animate);

        return () => {
          window.removeEventListener("resize", resize);
          window.removeEventListener("mousemove", handleMouseMove);
          window.removeEventListener("mouseleave", handleMouseLeave);
          if (animationRef.current) cancelAnimationFrame(animationRef.current);
        };
      }, [createParticle, PARTICLE_COUNT]);

      return (
        <div className="pointer-events-none fixed inset-0 z-0">
          <canvas ref={canvasRef} className="w-full h-full" />
        </div>
      );
    };

    // =============================================================================
    // GESTION DE LA MUSIQUE
    // =============================================================================
    const backgroundMusic = document.getElementById('backgroundMusic');
    const musicControl = document.getElementById('musicControl');
    let isMusicPlaying = false;
    let musicStarted = false;

    const startBackgroundMusic = () => {
      if (backgroundMusic && !musicStarted) {
        let stored = 0.2;
        try {
          const saved = localStorage.getItem('soulframe_volume');
          if (saved) {
            const v = parseFloat(saved);
            if (Number.isFinite(v) && v >= 0 && v <= 1) stored = v;
          }
        } catch (e) {}

        backgroundMusic.volume = stored;

        backgroundMusic.play().then(() => {
          isMusicPlaying = true;
          musicStarted = true;
          musicControl.classList.remove('muted');
          musicControl.setAttribute('aria-pressed', 'true');
        }).catch(() => {});
      }
    };

    const toggleMusic = () => {
      if (!backgroundMusic) return;
      if (isMusicPlaying) {
        backgroundMusic.pause();
        musicControl.classList.add('muted');
        musicControl.setAttribute('aria-pressed', 'false');
      } else {
        backgroundMusic.play();
        musicControl.classList.remove('muted');
        musicControl.setAttribute('aria-pressed', 'true');
      }
      isMusicPlaying = !isMusicPlaying;
    };

    const musicIcon = document.querySelector('#musicControl .music-icon-img');
    if (musicIcon) {
      musicIcon.addEventListener('click', toggleMusic);
    }

    window.addEventListener('load', () => setTimeout(startBackgroundMusic, 1000));
    backgroundMusic.addEventListener('ended', () => {
      backgroundMusic.currentTime = 0;
      backgroundMusic.play();
    });
    backgroundMusic.addEventListener('error', () => {
      musicControl.style.display = 'none';
    });

    // =============================================================================
    // HOOKS REACT ET COMPOSANTS DE BASE
    // =============================================================================
    const { useState, useEffect, useMemo, useRef } = React;

    // Composant Card réutilisable
    const Card = ({ id, title, children, className = "", defaultExpanded = true }) => {
      const [isExpanded, setIsExpanded] = useState(defaultExpanded);
      const contentRef = useRef(null);

      return (
        <section id={id} className="scroll-mt-24">
          <div className={`
            relative
            bg-[#0b0a08]/90
            border border-amber-700/70
            rounded-2xl
            shadow-[0_0_22px_rgba(0,0,0,0.85)]
            p-6 mb-8
            backdrop-blur-sm
            transition-all duration-300
            hover:shadow-amber-900/30
            hover:border-amber-500/80
            ${className}
          `}>
            <div className="absolute inset-1 rounded-2xl border border-amber-400/70 pointer-events-none" />
            <div className="relative z-10">
              <h2
                className="
                  text-2xl font-serif text-amber-300 drop-shadow mb-4
                  border-b border-amber-800/40 pb-2
                  flex items-center justify-between
                  cursor-pointer
                  hover:bg-amber-900/10
                  px-2 -mx-2 rounded-lg
                  transition-colors
                "
                onClick={() => setIsExpanded(v => !v)}
              >
                <span className="bg-gradient-to-r from-amber-400 to-amber-300 bg-clip-text text-transparent flex items-center gap-2">
                  {title}
                </span>
                <span
                  className="
                    text-amber-400/70 text-xl font-bold
                    w-6 h-6 flex items-center justify-center
                    bg-amber-900/30 rounded
                  "
                  aria-hidden="true"
                >
                  {isExpanded ? "−" : "+"}
                </span>
              </h2>

              <div
                ref={contentRef}
                className={`
                  transition-all duration-500 ease-in-out
                  ${isExpanded ? "max-h-[5000px] opacity-100" : "max-h-0 opacity-0 overflow-hidden"}
                `}
              >
                {children}
              </div>
            </div>
          </div>
        </section>
      );
    };

    // Composant MiniStatCard pour les petites statistiques
    const MiniStatCard = ({ label, value, icon, highlight = false, badgeLabel }) => (
      <div className="
        relative
        bg-[#0b0a08]/90
        border border-amber-700/70
        rounded-xl
        shadow-[0_0_18px_rgba(0,0,0,0.8)]
        px-5 py-4
        flex items-center gap-3
      ">
        <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
        <div className="relative z-10 flex items-center gap-3">
          <div className="w-7 h-7 flex items-center justify-center flex-shrink-0">
            {typeof icon === "string" ? <span className="text-xl">{icon}</span> : icon}
          </div>
          <div className="leading-tight">
            <div className="text-[11px] tracking-[0.16em] uppercase text-amber-300/80">
              {label}
            </div>
            <div className={`
              text-lg font-bold mt-1
              ${highlight ? "text-emerald-400" : "text-amber-50"}
            `}>
              {value}
              {badgeLabel && (
                <span className="
                  ml-1 text-[11px]
                  px-1.5 py-0.5
                  rounded-full
                  bg-emerald-900/40
                  text-emerald-300
                  border border-emerald-600/60
                  align-middle
                ">
                  {badgeLabel}
                </span>
              )}
            </div>
          </div>
        </div>
      </div>
    );

    // Composant DataTable pour les tableaux de données
    const DataTable = ({
      headers,
      data,
      className = "",
      isBoss = false,
      sortConfig,
      onSortChange
    }) => (
      <div className={`
        overflow-x-auto
        rounded-xl border
        ${isBoss ? "border-amber-600/30" : "border-amber-800/40"}
        shadow-inner
        ${className}
      `}>
        <table className="min-w-full text-sm">
          <thead className={`
            ${isBoss
              ? "bg-gradient-to-r from-[#2a1a0a] to-[#3a2a15]"
              : "bg-gradient-to-r from-[#1a1814] to-[#1f1d18]"
            }
            text-amber-300
            sticky
            top-0
            z-20
          `}>
            <tr>
              {headers.map((h, i) => {
                const label = typeof h === "string" ? h : h.label;
                const key = typeof h === "string" ? null : h.key;
                const isSortable = !!(onSortChange && key);
                const isActive = isSortable && sortConfig && sortConfig.key === key;
                const direction = isActive ? sortConfig.direction : null;

                return (
                  <th
                    key={label}
                    scope="col"
                    onClick={() => isSortable && onSortChange(key)}
                    className={`
                      px-4 py-3 text-left font-semibold
                      ${i === 0 ? "rounded-tl-xl" : ""}
                      ${i === headers.length - 1 ? "rounded-tr-xl" : ""}
                      ${isSortable
                        ? "cursor-pointer select-none hover:bg-amber-900/40"
                        : ""
                      }
                    `}
                  >
                    <div className="flex items-center gap-1">
                      <span>{label}</span>
                      {isActive && (
                        <span className="text-[10px] text-amber-400">
                          {direction === "asc" ? "▲" : "▼"}
                        </span>
                      )}
                    </div>
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody>
            {data.map((row, i) => (
              <tr
                key={i}
                className={
                  i % 2
                    ? "bg-[#12110f]/50 hover:bg-amber-900/10"
                    : "bg-[#181714]/30 hover:bg-amber-900/10"
                }
              >
                {row.map((cell, j) => (
                  <td
                    key={j}
                    className="px-4 py-3 text-amber-100 border-t border-amber-800/20"
                  >
                    {cell}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );

    // Composant AccordionSection pour les sections dépliables
    const AccordionSection = ({ title, subtitle, isOpen, onToggle, children }) => (
      <div className="
        relative
        bg-[#0b0a08]/90
        border border-amber-700/70
        rounded-xl
        shadow-[0_0_18px_rgba(0,0,0,0.8)]
        overflow-hidden
      ">
        <button
          type="button"
          onClick={onToggle}
          className="
            w-full
            flex items-center justify-between
            px-4 py-3
            text-left
            bg-amber-900/20
            hover:bg-amber-900/35
            transition-colors
          "
        >
          <div>
            <div className="text-sm font-semibold text-amber-200 flex items-center gap-2">
              {title}
            </div>
            {subtitle && (
              <div className="text-xs text-amber-400/80 mt-0.5">
                {subtitle}
              </div>
            )}
          </div>
          <span className="
            text-amber-300/80 text-xl font-bold
            w-6 h-6 flex items-center justify-center
            bg-amber-900/40 rounded
          ">
            {isOpen ? "−" : "+"}
          </span>
        </button>
        <div className={`
          transition-all duration-500 ease-in-out
          ${isOpen ? "max-h-[5000px] opacity-100" : "max-h-0 opacity-0 overflow-hidden"}
        `}>
          <div className="p-4">
            {children}
          </div>
        </div>
      </div>
    );

    // =============================================================================
    // CONSTANTES ET CONFIGURATIONS
    // =============================================================================
    const PROXY = "https://api.codetabs.com/v1/proxy?quest=";
    const SOULFRAME_API = "https://api.soulframe.com/cdn/getProfileViewingData.php?playerId=";
    const LORE_URL = "https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/docs/lore.json";

    // Configuration des onglets
    const ongletsConfig = [
      { id: 'player',    label: 'Player' },
      { id: 'boss',      label: 'Boss' },
      { id: 'enemies',   label: 'Enemies' },
      { id: 'weapons',   label: 'Weapons' },
      { id: 'abilities', label: 'Abilities' },
      { id: 'stats',     label: 'Statistics' },
      { id: 'settings',  label: 'Settings' }
    ];

    // Labels des capacités
    const ABILITY_LABELS = {
      FeyBloodLustAbility: { name: "Fellust", group: "Tethren", icon: "https://static.wikitide.net/soulframewiki/7/7a/BloodlustNoBacker.png" },
      FeyRageAbility: { name: "Call of the Ancients", group: "Tethren", icon: "https://static.wikitide.net/soulframewiki/b/ba/RageNoBacker.png" },
      FeyStompAbility: { name: "Clash", group: "Tethren", icon: "https://static.wikitide.net/soulframewiki/e/e2/SteadyFeetNoBacker.png" },
      FeyBlindAbility: { name: "Picktrix Powder", group: "Sirin", icon: "https://static.wikitide.net/soulframewiki/f/f2/PocketSandNoBacker.png" },
      FeyDecoyAbility: { name: "Trick of the Light", group: "Sirin", icon: "https://static.wikitide.net/soulframewiki/9/98/DecoyNoBacker.png" },
      FeyInvisibleAbility: { name: "Glamour", group: "Sirin", icon: "https://static.wikitide.net/soulframewiki/1/10/InvisibilityNoBacker.png" },
      FeyWardStoneAbility: { name: "Bestone", group: "Oscelda", icon: "https://static.wikitide.net/soulframewiki/b/b6/TurnToStoneNoBacker.png" },
      FeyHealthTotemAbility: { name: "Elderbloom", group: "Oscelda", icon: "https://static.wikitide.net/soulframewiki/1/13/HealingWardNoBacker.png" },
      FeyWardFlockAbility: { name: "Phantom Flock", group: "Oscelda", icon: "https://static.wikitide.net/soulframewiki/0/0b/RazorFlockNoBacker.png" },
      OdeWaveAbility: { name: "Seismor", group: "Ode Tempest", icon: "https://static.wikitide.net/soulframewiki/6/68/ShockwaveNoBacker.png" },
      OdeShockAbility: { name: "Astra Sphere", group: "Ode Tempest", icon: "https://static.wikitide.net/soulframewiki/8/87/ShockBallNoBacker.png" },
      OdeShieldAbility: { name: "Atmos Sphere", group: "Ode Tempest", icon: "https://static.wikitide.net/soulframewiki/b/b9/PersonalShieldNoBacker.png" },
      FireRainAbility: { name: "Ignus Wroth", group: "Mora's Hand", icon: "https://static.wikitide.net/soulframewiki/b/b4/FieryFissureNoBacker.png" },
      BlazeArmourAbility: { name: "Ember", group: "Mora's Hand", icon: "https://static.wikitide.net/soulframewiki/2/26/BlazingArmorNoBacker.png" },
      FirePushAbility: { name: "Inferno", group: "Mora's Hand", icon: "https://static.wikitide.net/soulframewiki/4/49/PyroBlastNoBacker.png" },
      BromiusSlamAbility: { name: "Rump Thump", group: "Bromius", icon: "https://static.wikitide.net/soulframewiki/7/70/CannonBallNoBacker.png" },
      BromiusRootAbility: { name: "Wevetroot", group: "Bromius", icon: "https://static.wikitide.net/soulframewiki/1/1c/RootSpikeNoBacker.png" },
      BromiusArmourAbility: { name: "Song of Growth", group: "Bromius", icon: "https://static.wikitide.net/soulframewiki/c/c3/ArmourPlatingNoBacker.png" },
      GarrenSapAbility: { name: "Torment", group: "Garren Rood", icon: "https://static.wikitide.net/soulframewiki/d/d2/SapNoBacker.png" },
      GarrenLightAbility: { name: "Behest", group: "Garren Rood", icon: "https://static.wikitide.net/soulframewiki/6/69/BlindingLightNoBacker.png" },
      StagStampedeAbility: { name: "Stampede", group: "Garren Rood", icon: "https://static.wikitide.net/soulframewiki/0/0a/StampedeNoBacker.png" },
      WolfAbility: { name: "Werewalker", group: "Orengall", icon: "https://static.wikitide.net/soulframewiki/8/83/BecomeWolf.png" },
      WolfPackAbility: { name: "Packhunter", group: "Orengall", icon: "https://static.wikitide.net/soulframewiki/c/cf/WhiteNoBacker-WolfPack.png" },
      WolfHowlAbility: { name: "Howl", group: "Orengall", icon: "https://static.wikitide.net/soulframewiki/a/a2/WhiteNoBacker-WolfHowl.png" }
    };

    // Ordre des groupes et icônes des pactes
    const GROUP_ORDER = ["Tethren","Sirin","Oscelda","Ode Tempest","Mora's Hand","Bromius","Garren Rood","Orengall"];
    const PACT_ICONS = {
      "Bromius":"https://static.wikitide.net/soulframewiki/1/13/BromiusPact.png",
      "Garren Rood":"https://static.wikitide.net/soulframewiki/5/5e/Pacts-Garren.png",
      "Mora's Hand":"https://static.wikitide.net/soulframewiki/e/ef/Pacts-FennJotar.png",
      "Ode Tempest":"https://static.wikitide.net/soulframewiki/a/aa/Pacts-Ode.png",
      "Orengall":"https://static.wikitide.net/soulframewiki/9/9c/Pacts-Orengal.png",
      "Oscelda":"https://static.wikitide.net/soulframewiki/b/bf/Oscelda.png",
      "Sirin":"https://static.wikitide.net/soulframewiki/d/dc/Sirin.png",
      "Tethren":"https://static.wikitide.net/soulframewiki/1/1c/Tethren.png"
    };

    // Noms et données des armes
    const WEAPON_NAMES = {
      "BromiusCleaverMeleeWeapon": { name: "Marrow's Bane", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/4/40/MarrowsBane.png" },
      "SphereSwordMeleeWeapon": { name: "Sollos-I", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/e/e3/SollosI.png" },
      "StarterSwordMeleeWeapon": { name: "Wulder", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/f/fb/Wulder.png" },
      "FennJotarSwordMeleeWeapon": { name: "IgneMora", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/e/eb/IgneMora.png" },
      "DendritSwordMeleeWeapon": { name: "Vetch", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/3/39/Vetch.png" },
      "MockeryTurashMeleeWeapon": { name: "Nurash", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/5/5f/Nurash.png" },
      "MockeryStultionMeleeWeapon": { name: "Stultin", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/7/76/Stultin.png" },
      "MockeryBrazardMeleeWeapon": { name: "Tessard", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/4/4f/Tessard.png" },
      "FeySwordMeleeWeapon": { name: "Dewelion", category: "main", group: "Long Blade", icon: "https://static.wikitide.net/soulframewiki/f/fb/Dewelion.png" },
      "SphereDualSwordsMeleeWeapon": { name: "Rivt-II", category: "main", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/2/2b/RivtII.png" },
      "GarrenSwordMeleeWeapon": { name: "The Royal Tines", category: "main", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/6/68/TheRoyalTines.png" },
      "SinecureDualDaggersMeleeWeapon": { name: "Unsula", category: "main", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/b/b7/Unsula.png" },
      "SpherePolearmMeleeWeapon": { name: "Vasp-IV", category: "main", group: "Polearm", icon: "https://static.wikitide.net/soulframewiki/c/c0/VaspIV.png" },
      "GarrenPolearmMeleeWeapon": { name: "Gathannan", category: "main", group: "Polearm", icon: "https://static.wikitide.net/soulframewiki/5/51/Gathannan.png" },
      "DeoraPolearmMeleeWeapon": { name: "Rook", category: "main", group: "Polearm", icon: "https://static.wikitide.net/soulframewiki/1/1b/Rook.png" },
      "CleansedSpearMeleeWeapon": { name: "Duhk Halic", category: "main", group: "Polearm", icon: "https://static.wikitide.net/soulframewiki/0/06/DuhkHalic.png" },
      "StarterStaffCasterRangedMeleeWeapon": { name: "Gwylen", category: "main", group: "Magick", icon: "https://static.wikitide.net/soulframewiki/5/53/Gwylen.png" },
      "WazzardStaffCasterRangedMeleeWeapon": { name: "The Erstroot", category: "main", group: "Magick", icon: "https://static.wikitide.net/soulframewiki/8/84/TheErstroot.png" },
      "OdeCastingDeviceRangedMeleeWeapon": { name: "Odiac", category: "main", group: "Magick", icon: "https://static.wikitide.net/soulframewiki/3/30/Odiac.png" },
      "StarterBowRangedMeleeWeapon": { name: "Thistle", category: "main", group: "Bow", icon: "https://static.wikitide.net/soulframewiki/1/1a/Thistle.png" },
      "OdeBowRangedMeleeWeapon": { name: "Blitzel", category: "main", group: "Bow", icon: "https://static.wikitide.net/soulframewiki/6/63/Blitzel.png" },
      "GrandFatherBowRangedMeleeWeapon": { name: "Juniper", category: "main", group: "Bow", icon: "https://static.wikitide.net/soulframewiki/9/9a/Juniper.png" },
      "DendritSwordAndBoardMeleeWeapon": { name: "Bog & Myrtle", category: "main", group: "Shield", icon: "https://static.wikitide.net/soulframewiki/7/77/BogandMyrtle.png" },
      "SphereSwordAndBoardMeleeWeapon": { name: "Oryn Umbr", category: "main", group: "Shield", icon: "https://static.wikitide.net/soulframewiki/5/57/OrynUmbr.png" },
      "SecondaryDaggerMeleeWeapon": { name: "Nettle", category: "secondary", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/4/40/Nettle.png" },
      "SecondaryDendritDaggerMeleeWeapon": { name: "Virdigris", category: "secondary", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/0/0b/Virdigris.png" },
      "SecondaryFeyDaggerMeleeWeapon": { name: "Witan", category: "secondary", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/a/a1/Witan.png" },
      "SecondaryOdeSawDaggerMeleeWeapon": { name: "Grinn", category: "secondary", group: "Short Blade", icon: "https://static.wikitide.net/soulframewiki/c/c7/Grinn.png" },
      "SecondaryStarterThrowingKnivesRangedMeleeWeapon": { name: "Precklies", category: "secondary", group: "Flyblade", icon: "https://static.wikitide.net/soulframewiki/b/b5/Precklies.png" },
      "SecondaryThrowingKnivesRangedMeleeWeapon": { name: "Skílter", category: "secondary", group: "Flyblade", icon: "https://static.wikitide.net/soulframewiki/3/3e/Skilter.png" }
    };

    // Configuration des sous-boss
    const SUBBOSS_CATEGORY = {
      name: "SubBoss",
      enemies: [
        "SpiderSubBossAvatar","NimrodSubBossAvatar","MendicantWazzardSubBossAvatar",
        "MockeryArmoredManSubBossAvatar","MendicantKnightBellCleaverSubBossAvatar",
        "MeleeGreatSwordSubBossAvatar","CorruptedSproutFolkSubBossAvatar",
        "RangedHunterSubBossAvatar","MeleeMaceOfficerSubBossAvatar","MendicantKingAvatar"
      ],
      labels: {
        SpiderSubBossAvatar:{ name:"Etheldred the Weaver", icon:"https://static.wikitide.net/soulframewiki/1/16/EtheldredTheWeaver.png" },
        NimrodSubBossAvatar:{ name:"Discharged Nimrod", icon:"https://static.wikitide.net/soulframewiki/c/cb/DischargedNimrod.jpg" },
        MendicantWazzardSubBossAvatar:{ name:"Wraith of Wastes", icon:"https://static.wikitide.net/soulframewiki/0/0b/WraithofWastes.jpg" },
        MockeryArmoredManSubBossAvatar:{ name:"Thrice-Bound Impidh", icon:"https://static.wikitide.net/soulframewiki/5/52/ThriceboundImpidh.jpg" },
        MendicantKnightBellCleaverSubBossAvatar:{ name:"Knell Knight", icon:"https://static.wikitide.net/soulframewiki/f/fe/KnellKnight.jpg" },
        MeleeGreatSwordSubBossAvatar:{ name:"Castellan Malrog", icon:"https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/Castellan%20Malrog.PNG" },
        CorruptedSproutFolkSubBossAvatar:{ name:"Kabocha", icon:"https://static.wikitide.net/soulframewiki/0/07/Kabocha.jpg" },
        RangedHunterSubBossAvatar:{ name:"Gruul Seeker Ruthos", icon:"https://static.wikitide.net/soulframewiki/0/02/GruulSeekerRuthos.jpg" },
        MeleeMaceOfficerSubBossAvatar:{ name:"Sinecure-errant Gawth", icon:"https://static.wikitide.net/soulframewiki/1/1e/SinecureerrantGawth.jpg" },
        MendicantKingAvatar:{ name:"Mendicant King", icon:"https://static.wikitide.net/soulframewiki/6/67/MendicantKingSquare.png" }
      }
    };

    // Catégories d'ennemis
    const ENEMY_CATEGORIES = {
      GRUNTS:{ name:"Grunt Standards", enemies:[
        "MeleeGruntAvatar","DualMeleeGruntAvatar","MeleeGruntShieldAvatar","MeleeGruntNightAvatar",
        "MeleeAxeGruntGladesAvatar","MeleeSpikedMaceGruntGladesAvatar","MeleeDualAxeGruntGladesAvatar",
        "MeleeLongSwordGruntGladesAvatar","CorruptedSproutFolkGruntAvatar","CorruptedSproutFolkSpearGruntAvatar",
        "UCGruntAvatar","UCDualGruntAvatar"
      ]},
      ELITES:{ name:"Élites", enemies:[
        "EliteMeleeGruntAvatar","MeleeGruntShieldEliteAvatar","DualMeleeGruntEliteAvatar",
        "EliteUCGruntAvatar","RangedHunterEliteAvatar","OdeCasterEliteAvatar","SpiderEliteAvatar"
      ]},
      RANGED:{ name:"Tireurs", enemies:["RangedHunterAvatar","RangedHunterGladesDaggerAvatar"]},
      OFFICERS:{ name:"Officiers", enemies:["MeleeSwordOfficerAvatar","MeleeMaceOfficerAvatar"]},
      ODE_TEMPEST:{ name:"Ode Tempest", enemies:["OdeCasterAvatar","OdeAttackDogAvatar"]},
      MENDICANT:{ name:"Mendicants", enemies:[
        "MendicantThrallAvatar","MendicantKnightAvatar","MendicantWazzardKnightAvatar",
        "MendicantCasterAvatar","MendicantWazzardAvatar"
      ]},
      SPECTRE:{ name:"Spectres", enemies:[
        "WanderingGhostSoldierAvatar","WanderingGhostKnightAvatar","WorldCircadeGhostKnightAvatar",
        "CircadeGhostKnightAvatar","HallowSpiritBaseAvatar","CryptSpiritBaseAvatar",
        "AvarotHallowSpiritAvatar","TalHallowSpiritAvatar"
      ]},
      CORRUPTED:{ name:"Corrompus", enemies:["CorruptedSproutFolkAvatar","CorruptedBromiusAvatar","GarrenHerdBaseAvatar"]},
      BOSSES:{ name:"Boss & Uniques", enemies:[
        "NimrodAvatar",
      ]},
      OTHER:{ name:"Divers", enemies:[]}
    };

    // Compendium des ennemis avec métadonnées
    const ENEMY_COMPENDIUM = {
      "MendicantCasterAvatar":{ name:"Mendicant Caster", faction:"Mendicant", biome:"Midrath", type:"Caster" },
      "MendicantKnightAvatar":{ name:"Mendicant Knight", faction:"Mendicant", biome:"Midrath", type:"Elite" },
      "MendicantThrallAvatar":{ name:"Mendicant Thrall", faction:"Mendicant", biome:"Midrath", type:"Grunt" },
      "MendicantWazzardAvatar":{ name:"Mendicant Wazzard", faction:"Mendicant", biome:"Midrath", type:"Caster" },
      "MendicantWazzardKnightAvatar":{ name:"Mendicant Wazzard Knight", faction:"Mendicant", biome:"Midrath", type:"Elite" },
      "MeleeGruntMessengerAvatar": {name: "Melee Grunt Messenger",faction: "Ode",biome: "Midrath",type: "Grunt"},
      "MeleeGruntAvatar":{ name:"Mendicant Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "DualMeleeGruntAvatar":{ name:"Dual Wielder", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "EliteMeleeGruntAvatar":{ name:"Elite Grunt", faction:"Ode", biome:"Midrath", type:"Elite" },
      "RangedHunterAvatar":{ name:"Ranged Hunter", faction:"Ode", biome:"Midrath", type:"Ranged" },
      "RangedHunterEliteAvatar":{ name:"Elite Ranged Hunter", faction:"Ode", biome:"Midrath", type:"Elite" },
      "OdeAttackDogAvatar":{ name:"Ode Dog", faction:"Ode", biome:"Midrath", type:"Beast" },
      "OdeCasterAvatar":{ name:"Ode Caster", faction:"Ode", biome:"Midrath", type:"Caster" },
      "OdeCasterEliteAvatar":{ name:"Ode Caster Elite", faction:"Ode", biome:"Midrath", type:"Elite" },
      "SiegeEngineTaleAvatar":{ name:"Ode'n Bisulcam", faction:"Ode", biome:"Midrath", type:"Siege" },
      "MeleeMaceAvatar":{ name:"Ode Mace Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeSwordAvatar":{ name:"Ode Sword Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "RangedHunterGladesDaggerAvatar":{ name:"Ranged Hunter", faction:"Ode", biome:"Midrath", type:"Ranged" },
      "MeleeDaggerAndShieldAvatar":{ name:"Ode Dagger Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeAxeAvatar":{ name:"Capitaine Greataxe", faction:"Ode", biome:"Midrath", type:"Officer" },
      "MeleeSwordOfficerAvatar":{ name:"Ode Sword Officer", faction:"Ode", biome:"Midrath", type:"Officer" },
      "MeleeMaceOfficerAvatar":{ name:"Ode Mace Officer", faction:"Ode", biome:"Midrath", type:"Officer" },
      "NimrodAvatar":{ name:"Discharged Nimrod", faction:"Ode", biome:"Midrath", type:"Boss" },
      "WazzardSpiderAvatar":{ name:"Wazzard Weaver", faction:"Corrupted", biome:"Midrath", type:"Caster" },
      "GarrenHerdBaseAvatar":{ name:"Vadagar Stag", faction:"Corrupted", biome:"Midrath", type:"Boss" },
      "CorruptedSlugAvatar":{ name:"Corrupted Slug", faction:"Corrupted", biome:"Midrath", type:"Beast" },
      "CorruptedSproutFolkAvatar":{ name:"Corrupted Sprout", faction:"Corrupted", biome:"Midrath", type:"Grunt" },
      "CorruptedSproutFolkGruntAvatar":{ name:"Avakot corrompu", faction:"Corrupted", biome:"Midrath", type:"Grunt" },
      "CorruptedSproutFolkSpearGruntAvatar":{ name:"Corrupted Spear Grunt", faction:"Corrupted", biome:"Midrath", type:"Grunt" },
      "BaliqShrimpAvatar":{ name:"Baliq Shrimp", faction:"Corrupted", biome:"Midrath", type:"Beast" },
      "BaliqShrimpGladesAvatar":{ name:"Baliq Shrimp", faction:"Corrupted", biome:"Midrath", type:"Beast" },
      "MockeryArmoredManAvatar":{ name:"Mockery Armored", faction:"Mockery", biome:"Midrath", type:"Grunt" },
      "MockeryManAvatar":{ name:"Mockery", faction:"Mockery", biome:"Midrath", type:"Grunt" },
      "AvarotHallowSpiritAvatar":{ name:"Avarot Hallow Spirit", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "HallowSpiritBaseAvatar":{ name:"Hallow Spirit", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "TalHallowSpiritAvatar":{ name:"Tal Hallow Spirit", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "CryptSpiritBaseAvatar":{ name:"Crypt Spirit", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "MeleeDualAxeGruntGladesAvatar":{ name:"Dual Axe Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "SquidplantAvatar":{ name:"Will-o-wing", faction:"Hazards", biome:"Midrath", type:"Hazard" },
      "SquidplantChildAvatar":{ name:"Child Will-o-wing", faction:"Hazards", biome:"Midrath", type:"Hazard" },
      "MeleeGruntShieldAvatar":{ name:"Shield Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeGruntNightAvatar":{ name:"Night Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeAxeGruntGladesAvatar":{ name:"Axe Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeSpikedMaceGruntGladesAvatar":{ name:"Spiked Mace Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeLongSwordGruntGladesAvatar":{ name:"Long Sword Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "UCGruntAvatar":{ name:"UC Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "UCDualGruntAvatar":{ name:"UC Dual Grunt", faction:"Ode", biome:"Midrath", type:"Grunt" },
      "MeleeGruntShieldEliteAvatar":{ name:"Shield Elite", faction:"Ode", biome:"Midrath", type:"Elite" },
      "DualMeleeGruntEliteAvatar":{ name:"Dual Wielder Elite", faction:"Ode", biome:"Midrath", type:"Elite" },
      "EliteUCGruntAvatar":{ name:"UC Elite", faction:"Ode", biome:"Midrath", type:"Elite" },
      "WanderingGhostSoldierAvatar":{ name:"Wandering Ghost Soldier", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "WanderingGhostKnightAvatar":{ name:"Wandering Ghost Knight", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "WorldCircadeGhostKnightAvatar":{ name:"World Circade Ghost Knight", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "CircadeGhostKnightAvatar":{ name:"Circade Ghost Knight", faction:"Spectres", biome:"Midrath", type:"Spirit" },
      "MeleeGreatSwordSubBossAvatar":{ name:"Castellan Malrog", faction:"Ode", biome:"Midrath", type:"SubBoss" },
      "SpiderAvatar":{ name:"Weaver (Spider)", faction:"Corrupted", biome:"Midrath", type:"Beast" },
      "SpiderEliteAvatar":{ name:"Weaver Elite", faction:"Corrupted", biome:"Midrath", type:"Elite" },
      "MendicantWazzardSubBossAvatar":{ name:"Wraith of Wastes", faction:"Mendicant", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/0/0b/WraithofWastes.jpg" },
      "NimrodSubBossAvatar": { name:"Discharged Nimrod", faction:"Ode", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/c/cb/DischargedNimrod.jpg" },
      "SpiderSubBossAvatar":{ name:"Etheldred the Weaver", faction:"Corrupted", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/1/16/EtheldredTheWeaver.png" },
      "MockeryArmoredManSubBossAvatar":{ name:"Thrice-Bound Impidh", faction:"Mockery", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/5/52/ThriceboundImpidh.jpg" },
      "MendicantKnightBellCleaverSubBossAvatar": { name:"Knell Knight", faction:"Mendicant", biome:"Midrath", type:"Agari" },
      "MeleeMaceOfficerSubBossAvatar": { name:"Sinecure-errant Gawth", faction:"Ode", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/1/1e/SinecureerrantGawth.jpg" },
      "RangedHunterSubBossAvatar": { name:"Gruul Seeker Ruthos", faction:"Ode", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/0/02/GruulSeekerRuthos.jpg" },
      "MendicantKingAvatar":{ name:"Mendicant King", faction:"Mendicant", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/6/67/MendicantKingSquare.png" },
      "CorruptedSproutFolkSubBossAvatar":{ name:"Kabocha", faction:"Corrupted", biome:"Midrath", type:"Agari", icon:"https://static.wikitide.net/soulframewiki/0/07/Kabocha.jpg" },
      "MeleeGreatSwordSubBossAvatar":{ name:"Castellan Malrog", faction: "Ode", biome:"Midrath", type:"Enemie", icon:"https://static.wikitide.net/soulframewiki/thumb/6/6f/Castellan_Malrog.jpg/800px-Castellan_Malrog.jpg" }
    };

    // Renommage des ennemis pour l'affichage
    const ENEMY_RENAMES = {
      MockeryMan: "Mockery",
      MockeryArmoredMan: "Mockery Armored",
      CryptSpiritBase: "Crypt Spirit",
      HallowSpiritBase: "Hallow Spirit",
      MeleeMaceOfficerSubBoss: "Sinecure-errant Gawth",
      MeleeGreatSwordSubBoss: "Castellan Malrog",
      MendicantKnightBellCleaverSubBoss: "The Circade Ghost",
      Spider: "Weaver (Spider)",
      SpiderElite: "Weaver Elite",
      OdeAttackDog: "Ode Dog",
      SiegeEngineTale: "Ode'n Bisulcam",
      DualMeleeGrunt: "Dual Wielder",
      BaliqShrimp: "Baliq Shrimp",
      BaliqShrimpGlades: "Baliq Shrimp",
      Squidplant: "Will-o-wing",
      SquidplantChild: "Child Will-o-wing",
      CorruptedSproutFolkGrunt: "Avakot corrompu",
      GarrenHerdBase: "Vadagar Stag",
      MeleeAxe: "Capitaine Greataxe"
    };

    // Ennemis exclus du compendium
    const COMPENDIUM_EXCLUDED = new Set([
      "MendicantWazzardSubBoss",
      "NimrodSubBoss",
      "SpiderSubBoss",
      "MockeryArmoredManSubBoss",
      "MendicantKnightBellCleaverSubBoss",
      "MeleeMaceOfficerSubBoss",
      "RangedHunterSubBoss",
      "MendicantKing",
      "CorruptedSproutFolkSubBoss",
      "MeleeGreatSwordSubBoss",
      "BaliqShrimp",
      "BaliqShrimpGlades",
      "SfProxy",
      "OrengallQuestSiegeEngine",
      "CorruptedBromius",
      "Envoy",
    ]);

    // =============================================================================
    // COMPOSANT "WHAT'S NEW" - NOTES DE VERSION
    // =============================================================================
    function LatestPatchNotes({ lang }) {
      if (lang === "fr") {
        return (
          <div className="space-y-4 text-sm leading-relaxed text-amber-50">
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-amber-400 mb-1">
                Soulframe Tracker
              </p>
              <h2 className="text-lg font-semibold text-amber-100">
                Nouveautés de cette version
              </h2>
              <p className="text-xs text-amber-300/80">
                Un petit récap des derniers ajouts et ajustements.
              </p>
            </div>

            <div className="space-y-3">
              <section>
                <h3 className="text-amber-200 font-semibold text-sm mb-1">
                  Barre d&apos;actions &amp; mises à jour
                </h3>
                <ul className="list-disc list-inside space-y-1 text-amber-100/90">
                  <li>
                    Nouvelle barre d&apos;action en haut avec le bouton{" "}
                    <span className="font-semibold">Mise à jour</span>, le{" "}
                    <span className="font-semibold">timer Dernière mise à jour</span>{" "}
                    et un indicateur clair de{" "}
                    <span className="font-semibold">Mises à jour automatiques</span>{" "}
                    lié à l&apos;onglet Paramètres.
                  </li>
                  <li>
                    Le bouton <span className="font-semibold">Définir une référence</span>{" "}
                    fixe un nouveau point de départ&nbsp;: les tags verts et les valeurs
                    cumulées sont remis à zéro pour suivre uniquement ce qui a changé
                    depuis ce moment-là.
                  </li>
                </ul>
              </section>

              <section>
                <h3 className="text-amber-200 font-semibold text-sm mb-1">
                  Onglet Joueur revisité
                </h3>
                <p className="text-amber-100/90">
                  L&apos;onglet <span className="font-semibold">Joueur</span> a été
                  réorganisé&nbsp;: mise en page plus claire, informations plus
                  lisibles et aperçu plus complet de votre profil Soulframe.
                </p>
              </section>

              <section>
                <h3 className="text-amber-200 font-semibold text-sm mb-1">
                  Statistiques &amp; suivi d&apos;activité
                </h3>
                <ul className="list-disc list-inside space-y-1 text-amber-100/90">
                  <li>
                    Nouvel onglet <span className="font-semibold">Statistiques</span>{" "}
                    qui affiche votre temps de jeu réel&nbsp;:{" "}
                    <span className="font-semibold">Aujourd&apos;hui</span>,{" "}
                    <span className="font-semibold">Semaine</span> et{" "}
                    <span className="font-semibold">Mois</span>.
                  </li>
                  <li>
                    La visualisation d&apos;activité suit vos{" "}
                    <span className="font-semibold">kills</span>,{" "}
                    <span className="font-semibold">mini-boss</span>,{" "}
                    <span className="font-semibold">objets ramassés</span> et{" "}
                    <span className="font-semibold">dracs</span> au fil du temps,
                    pour voir en un coup d&apos;œil comment s&apos;est passée chaque
                    session.
                  </li>
                </ul>
              </section>

              <section>
                <h3 className="text-amber-200 font-semibold text-sm mb-1">
                  Les paramètres entrent en scène
                </h3>
                <p className="text-amber-100/90">
                  L&apos;onglet <span className="font-semibold">Paramètres</span> est
                  maintenant de la fête&nbsp;: activez ou désactivez les mises à jour
                  automatiques, ajustez le comportement du tracker et gardez les
                  options expérimentales bien rangées au même endroit!
                </p>
              </section>

              <section>
                <h3 className="text-amber-200 font-semibold text-sm mb-1">
                  Système Pokémote – v1
                </h3>
                <p className="text-amber-100/90">
                  Une première version du{" "}
                  <span className="font-semibold">système Pokémote!</span> est en
                  ligne&nbsp;: de petites motes apparaissent parfois à l&apos;écran {" "}
                  cliquez plusieurs fois dessus avant qu&apos;elles disparaissent!! 
                  Collectionne-les pour devenir une vraie légende✨{" "}
                  <span className="font-semibold"></span>.
                </p>
              </section>

              <section>
                <h3 className="text-amber-200 font-semibold text-sm mb-1">
                  Tags verts &amp; petits coups de pouce
                </h3>
                <p className="text-amber-100/90">
                  Les <span className="font-semibold">tags verts</span> mettent en
                  évidence tout ce qui a changé depuis votre dernière référence&nbsp;:
                  kills en plus, dracs gagnés, nouveaux objets… plus besoin de deviner
                  d&apos;où vient la progression!
                </p>
                <p className="text-amber-100/90">
                  Et si quelque chose a l&apos;air étrange, c&apos;est soit un bug,
                  soit le tracker qui essaie très fort de vous aider. Dans les deux
                  cas, il est probablement bien intentionné :p.
                </p>
              </section>
            </div>
          </div>
        );
      }

      // Version anglaise
      return (
        <div className="space-y-4 text-sm leading-relaxed text-amber-50">
          <div>
            <p className="text-xs uppercase tracking-[0.2em] text-amber-400 mb-1">
              Soulframe Tracker
            </p>
            <h2 className="text-lg font-semibold text-amber-100">
              What&apos;s new in this build
            </h2>
            <p className="text-xs text-amber-300/80">
              A quick recap of the latest tweaks and shiny toys.
            </p>
          </div>

          <div className="space-y-3">
            <section>
              <h3 className="text-amber-200 font-semibold text-sm mb-1">
                Action bar &amp; updates
              </h3>
              <ul className="list-disc list-inside space-y-1 text-amber-100/90">
                <li>
                  New action bar at the top with your{" "}
                  <span className="font-semibold">Update</span> button,{" "}
                  <span className="font-semibold">Last updated</span> timer and a
                  clear <span className="font-semibold">Automatic Updates</span>{" "}
                  indicator tied to the Settings tab.
                </li>
                <li>
                  The <span className="font-semibold">Set Reference</span> button
                  lets you define a new baseline: green tags and cumulative diffs
                  are reset so you can clearly see what changed since that moment.
                </li>
              </ul>
            </section>

            <section>
              <h3 className="text-amber-200 font-semibold text-sm mb-1">
                Player tab rework
              </h3>
              <p className="text-amber-100/90">
                The <span className="font-semibold">Player</span> tab has been
                cleaned up and expanded: clearer layout, more useful information at
                a glance and a better overview of your Soulframe profile.
              </p>
            </section>

            <section>
              <h3 className="text-amber-200 font-semibold text-sm mb-1">
                Statistics &amp; activity tracking
              </h3>
              <ul className="list-disc list-inside space-y-1 text-amber-100/90">
                <li>
                  New <span className="font-semibold">Statistics</span> tab showing
                  your real playtime:{" "}
                  <span className="font-semibold">Today</span>,{" "}
                  <span className="font-semibold">Week</span> and{" "}
                  <span className="font-semibold">Month</span>.
                </li>
                <li>
                  Activity visualization tracks your{" "}
                  <span className="font-semibold">kills</span>,{" "}
                  <span className="font-semibold">sub-boss kills</span>,{" "}
                  <span className="font-semibold">items collected</span> and{" "}
                  <span className="font-semibold">dracs</span> over time, so you can
                  see how each session went at a glance.
                </li>
              </ul>
            </section>

            <section>
              <h3 className="text-amber-200 font-semibold text-sm mb-1">
                Settings join the party
              </h3>
              <p className="text-amber-100/90">
                The <span className="font-semibold">Settings</span> tab is now
                officially invited to the feast: toggle automatic updates, adjust
                behaviour and keep experimental features under control without
                leaving the app.
              </p>
            </section>

            <section>
              <h3 className="text-amber-200 font-semibold text-sm mb-1">
                Pokémote system – v1
              </h3>
              <p className="text-amber-100/90">
                A first version of the{" "}
                <span className="font-semibold">Pokémote</span> system is live:
                tiny motes occasionally appear on your screen click them several
                times before they vanish! Collect them to become a true legend✨
              </p>
            </section>

            <section>
              <h3 className="text-amber-200 font-semibold text-sm mb-1">
                Green tags &amp; tiny helpers
              </h3>
              <p className="text-amber-100/90">
                <span className="font-semibold">Green tags</span> highlight
                everything that changed since your last reference: new kills, extra
                dracs, shiny gear… so you don&apos;t have to guess where the
                progress came from.
              </p>
              <p className="text-amber-100/90">
                If something looks weird, it&apos;s probably not a bug — just the
                tracker trying very hard to help. Or a bug. But a friendly one.
                Probably.
              </p>
            </section>
          </div>
        </div>
      );
    }

    // Modal "What's New"
    function WhatsNewModal({ open, onClose, lang, onChangeLang }) {
      if (!open) return null;

      const title = lang === "fr" ? "Quoi de neuf ?" : "What's new?";

      return (
        <div className="fixed inset-0 z-40 flex items-center justify-center">
          {/* Fond sombre */}
          <div
            className="absolute inset-0 bg-black/70 backdrop-blur-sm"
            onClick={onClose}
          />

          {/* Contenu de la fenêtre */}
          <div className="relative z-50 max-w-lg w-[90%] md:w-[32rem] rounded-2xl border border-amber-500/60 bg-gradient-to-b from-amber-950/95 via-stone-950/95 to-black/95 shadow-2xl shadow-black/80 p-5 md:p-6">
            <div className="flex items-start justify-between mb-3 gap-3">
              {/* Titre + switch langue */}
              <div className="flex-1">
                <h2 className="text-base md:text-lg font-semibold text-amber-50">
                  {title}
                </h2>
                <div className="mt-1 inline-flex rounded-full border border-amber-500/50 bg-black/30 text-[11px] overflow-hidden">
                  <button
                    type="button"
                    onClick={() => onChangeLang("en")}
                    className={
                      "px-2 py-[2px] " +
                      (lang === "en"
                        ? "bg-amber-500/80 text-black font-semibold"
                        : "text-amber-200/80 hover:bg-amber-900/60")
                    }
                  >
                    EN
                  </button>
                  <button
                    type="button"
                    onClick={() => onChangeLang("fr")}
                    className={
                      "px-2 py-[2px] " +
                      (lang === "fr"
                        ? "bg-amber-500/80 text-black font-semibold"
                        : "text-amber-200/80 hover:bg-amber-900/60")
                    }
                  >
                    FR
                  </button>
                </div>
              </div>

              {/* Image plume + bouton fermeture */}
              <div className="flex flex-col items-end gap-1">
                <img
                  src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/QuillIcon.png"
                  alt="Quill icon"
                  className="w-9 h-9 drop-shadow-[0_0_10px_rgba(251,191,36,0.6)]"
                />
                <button
                  onClick={onClose}
                  className="inline-flex items-center justify-center rounded-full w-6 h-6 text-amber-200 bg-amber-900/60 hover:bg-amber-800/90 border border-amber-500/70 text-xs font-semibold transition-colors"
                  aria-label={lang === "fr" ? "Fermer les notes" : "Close patch notes"}
                >
                  ✕
                </button>
              </div>
            </div>

            <div className="max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
              <LatestPatchNotes lang={lang} />
            </div>
          </div>
        </div>
      );
    }

        // Popup d'aide pour l'AccountId (même style que le "What's new?")
    function AccountIdHelpModal({ open, onClose, lang, onChangeLang }) {
      if (!open) return null;

      const titleFR = "Comment trouver votre Account ID Soulframe ?";
      const titleEN = "How to find your Soulframe Account ID";

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* Voile de fond cliquable pour fermer */}
          <div
            className="absolute inset-0 bg-black/70 backdrop-blur-sm"
            onClick={onClose}
          />
          {/* Contenu de la popup */}
          <div className="relative z-50 max-w-lg w-[90%] md:w-[32rem] rounded-2xl border border-amber-500/60 bg-gradient-to-b from-amber-950/95 via-stone-950/95 to-black/95 shadow-2xl shadow-black/80 p-5 md:p-6">
            <div className="flex items-start justify-between mb-3 gap-3">
              <div className="flex-1">
                <h2 className="text-base md:text-lg font-semibold text-amber-50">
                  {lang === "fr" ? titleFR : titleEN}
                </h2>
                <div className="mt-1 inline-flex rounded-full border border-amber-500/50 bg-black/30 text-[11px] overflow-hidden">
                  <button
                    type="button"
                    onClick={() => onChangeLang("en")}
                    className={
                      "px-2 py-[2px] " +
                      (lang === "en"
                        ? "bg-amber-500/80 text-black font-semibold"
                        : "text-amber-200/80 hover:bg-amber-900/60")
                    }
                  >
                    EN
                  </button>
                  <button
                    type="button"
                    onClick={() => onChangeLang("fr")}
                    className={
                      "px-2 py-[2px] " +
                      (lang === "fr"
                        ? "bg-amber-500/80 text-black font-semibold"
                        : "text-amber-200/80 hover:bg-amber-900/60")
                    }
                  >
                    FR
                  </button>
                </div>
              </div>

              {/* Bouton fermeture */}
              <div className="flex flex-col items-end gap-1">
                <button
                  onClick={onClose}
                  className="inline-flex items-center justify-center rounded-full w-6 h-6 text-amber-200 bg-amber-900/60 hover:bg-amber-800/90 border border-amber-500/70 text-xs font-semibold transition-colors"
                  aria-label={lang === "fr" ? "Fermer l'aide Account ID" : "Close Account ID help"}
                >
                  ✕
                </button>
              </div>
            </div>

            <div className="max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar text-sm leading-relaxed text-amber-100/90 space-y-3">
              {lang === "fr" ? (
                <>
                  <p>
                    Pour utiliser le tracker, vous devez renseigner votre{" "}
                    <span className="font-semibold">Account ID Soulframe</span>.
                  </p>
                  <p className="font-semibold text-amber-300">
                    📋 Méthode recommandée (via le launcher) :
                  </p>
                  <ol className="list-decimal list-inside space-y-1">
                    <li>Ouvrez le <span className="font-semibold">launcher Soulframe</span>.</li>
                    <li>Allez dans <span className="font-semibold">Paramètres ⚙️</span>.</li>
                    <li>Cliquez sur <span className="font-semibold">« Diagnostique [Fichiers Logs] »</span>.</li>
                    <li>Un dossier sera créé sur votre <span className="font-semibold">Bureau</span>.</li>
                    <li>Ouvrez le fichier <span className="font-semibold">EE.log</span>.</li>
                    <li>
                      Appuyez sur <span className="font-semibold">Ctrl + F</span> et cherchez&nbsp;:
                      <code className="font-mono text-amber-200 block my-1">
                        Sys [Info]: Logged in
                      </code>
                    </li>
                    <li>
                      Votre pseudo et votre{" "}
                      <span className="font-semibold">Account ID (24 caractères)</span> seront indiqués
                      sur cette ligne.
                    </li>
                  </ol>
                  <p className="font-semibold text-amber-300">
                    🔄 Si la recherche ne donne rien :
                  </p>
                  <ul className="list-disc list-inside space-y-1">
                    <li>Lancez le jeu, jouez 1–2 minutes puis fermez-le proprement.</li>
                    <li>Refaites un « Diagnostique [Fichiers Logs] » et recherchez à nouveau.</li>
                  </ul>
                  <p className="mt-1 text-xs text-amber-200/80">
                    ⚠️ Votre Account ID est personnel – partagez-le uniquement avec des sources
                    de confiance.
                  </p>
                </>
              ) : (
                <>
                  <p>
                    To use the tracker you need to provide your{" "}
                    <span className="font-semibold">Soulframe Account ID</span>.
                  </p>
                  <p className="font-semibold text-amber-300">
                    📋 Recommended method (via the launcher):
                  </p>
                  <ol className="list-decimal list-inside space-y-1">
                    <li>Open the <span className="font-semibold">Soulframe launcher</span>.</li>
                    <li>Go to <span className="font-semibold">Settings ⚙️</span>.</li>
                    <li>Click on <span className="font-semibold">“Diagnose [Log Files]”</span>.</li>
                    <li>A folder will be created on your <span className="font-semibold">Desktop</span>.</li>
                    <li>Open the <span className="font-semibold">EE.log</span> file.</li>
                    <li>
                      Press <span className="font-semibold">Ctrl + F</span> and search for:
                      <code className="font-mono text-amber-200 block my-1">
                        Sys [Info]: Logged in
                      </code>
                    </li>
                    <li>
                      On that line you will see your nickname and your{" "}
                      <span className="font-semibold">Account ID (24 characters)</span>.
                    </li>
                  </ol>
                  <p className="font-semibold text-amber-300">
                    🔄 If the search returns nothing:
                  </p>
                  <ul className="list-disc list-inside space-y-1">
                    <li>Launch the game, play 1–2 minutes, then close it properly.</li>
                    <li>Run “Diagnose [Log Files]” again and search once more.</li>
                  </ul>
                  <p className="mt-1 text-xs text-amber-200/80">
                    ⚠️ Your Account ID is personal – only share it with tools and people you trust.
                  </p>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }


    // Bouton "What's New"
    function WhatsNewButton({ onOpen }) {
      return (
        <button
          type="button"
          onClick={onOpen}
          className="fixed bottom-4 left-4 z-50 group"
          aria-label="Open patch notes"
        >
          <span className="absolute inset-0 blur-xl bg-amber-400/40 rounded-full opacity-70 group-hover:opacity-90 group-hover:scale-110 transition-transform transition-opacity duration-200 pointer-events-none" />
          <span className="relative flex items-center justify-center w-11 h-11 rounded-full bg-amber-50/90 text-amber-900 border border-amber-300 shadow-lg shadow-amber-500/40 group-hover:shadow-amber-400/80 group-hover:scale-105 transition-transform duration-150">
            <span className="text-[11px] font-semibold tracking-wide">
              ?
            </span>
          </span>
        </button>
      );
    }

    // =============================================================================
    // COMPOSANT PRINCIPAL DE L'APPLICATION
    // =============================================================================
    const App = () => {
      // États principaux
      const [view, setView] = useState("PA");
      const [isTransitioning, setIsTransitioning] = useState(false);
      const [payload, setPayload] = useState(null);
      const [error, setError] = useState("");
      const [accountId, setAccountId] = useState("");
      const [isUpdating, setIsUpdating] = useState(false);
      const [updateMessage, setUpdateMessage] = useState("");
      const [activeTab, setActiveTab] = useState("player");
      const [openEnemyPanel, setOpenEnemyPanel] = useState("index");
      // Auto-dismiss du toast de mise à jour
    useEffect(() => {
    if (!updateMessage) return;
    // Durée différente selon succès/erreur
    const delay = updateMessage.includes("❌") ? 4000 : 2500;
    const timer = setTimeout(() => {
      setUpdateMessage("");
    }, delay);
    return () => clearTimeout(timer);
     }, [updateMessage]);
      // États pour les fonctionnalités
      const [isWhatsNewOpen, setIsWhatsNewOpen] = useState(false);
      const [patchLang, setPatchLang] = useState("en");
      const [autoUpdate, setAutoUpdate] = useState(() => {
        try {
          const saved = localStorage.getItem('soulframe_autoUpdate');
          return saved ? JSON.parse(saved) : true;
        } catch {
          return true;
        }
      });
      
            // États pour le système de motes
      const [moteScore, setMoteScore] = useState(() => {
        const saved = localStorage.getItem("sf_mote_score");
        return saved ? parseInt(saved, 10) || 0 : 0;
      });
      const [moteRankLang, setMoteRankLang] = useState("fr");

      // États pour les tags verts (progression)


      // États pour les tags verts (progression)
      const [greenTagsRefreshKey, setGreenTagsRefreshKey] = useState(0);
      const [volume, setVolume] = useState(() => {
        try {
          const saved = localStorage.getItem("soulframe_volume");
          if (!saved) return 0.2;
          const v = parseFloat(saved);
          return Number.isFinite(v) && v >= 0 && v <= 1 ? v : 0.2;
        } catch {
          return 0.2;
        }
      });

      // États pour les différences (tags verts)
      const [weaponDiffs, setWeaponDiffs] = useState({});
      const [enemyDiffs, setEnemyDiffs] = useState({});
      const [statDiffs, setStatDiffs] = useState({});
      const [hasChanges, setHasChanges] = useState(false);
      const [weaponBonuses, setWeaponBonuses] = useState({});
      const [enemyBonuses, setEnemyBonuses] = useState({});
      const [statBonuses, setStatBonuses] = useState({});

            // États pour le lore, la langue et l'aide AccountId
      const [loreLines, setLoreLines] = useState([]);
      const [loreIdx, setLoreIdx] = useState(0);
      const [language, setLanguage] = useState("en");
      const [loreLinesFR, setLoreLinesFR] = useState([]);

      const [isAccountHelpOpen, setIsAccountHelpOpen] = useState(false);
      const [accountHelpLang, setAccountHelpLang] = useState("fr");
      const [highlightHelpButton, setHighlightHelpButton] = useState(false);
      const helpHighlightTimer = useRef(null);


      // États pour les statistiques et références
      const [statsModule, setStatsModule] = useState(() => window.SoulframeStats || null);
      const [referenceData, setReferenceData] = useState(() => {
        try {
          const savedReference = localStorage.getItem('soulframe_reference');
          return savedReference ? JSON.parse(savedReference) : null;
        } catch (e) {
          return null;
        }
      });
      
      const [currentTime, setCurrentTime] = useState(new Date());
      const [globalRefreshKey, setGlobalRefreshKey] = useState(0);

      // =============================================================================
      // EFFETS ET HOOKS PERSONNALISÉS
      // =============================================================================

      // Timer pour l'affichage des mises à jour
      const TimerDisplay = ({ statsModule }) => {
        const [currentTime, setCurrentTime] = useState(new Date());
        
        useEffect(() => {
          const interval = setInterval(() => {
            setCurrentTime(new Date());
          }, 30000); // 30 secondes

          return () => clearInterval(interval);
        }, []);
        
        return statsModule ? statsModule.getTimerDisplay() : "Never updated";
      };

      // Initialisation du module de statistiques
      useEffect(() => {
        const initStatsModule = () => {
          if (window.SoulframeStats) {
            const module = window.SoulframeStats;
            module.loadFromStorage();
            setStatsModule(module);
            
            // Configurer la notification globale
            window.triggerStatsUpdate = () => {
              setGlobalRefreshKey(prev => prev + 1);
            };
            
            if (autoUpdate) {
              module.initializeTimer(() => {
                refreshData('auto');
              }, 10 * 60 * 1000);
            }
          } else {
            setStatsModule({
              getTimerDisplay: () => "Never updated",
              loadFromStorage: () => {},
              initializeTimer: () => {},
              trackSession: () => {},
              exportStatistics: () => alert("Module non chargé"),
              renderStatisticsUI: () => "<div>Chargement des statistiques...</div>",
              renderSettingsUI: () => "<div>Paramètres non disponibles</div>"
            });
          }
        };

        const timer = setTimeout(initStatsModule, 100);
        return () => {
          clearTimeout(timer);
          window.triggerStatsUpdate = null;
        };
      }, [autoUpdate]);

           // Mise en avant du bouton d'aide AccountId (halo orange)
      const handleAccountIdFocus = () => {
        if (!accountId) {
          if (helpHighlightTimer.current) {
            clearTimeout(helpHighlightTimer.current);
          }
          setHighlightHelpButton(true);
          helpHighlightTimer.current = setTimeout(() => {
            setHighlightHelpButton(false);
            helpHighlightTimer.current = null;
          }, 4000);
        }
      };

      const handleAccountHelpButtonClick = () => {
        if (helpHighlightTimer.current) {
          clearTimeout(helpHighlightTimer.current);
          helpHighlightTimer.current = null;
        }
        setHighlightHelpButton(false);
        setIsAccountHelpOpen(true);
      };

      useEffect(() => {
        return () => {
          if (helpHighlightTimer.current) {
            clearTimeout(helpHighlightTimer.current);
          }
        };
      }, []);


      // Gestion de l'AccountId dans le localStorage
      useEffect(() => {
        const saved = localStorage.getItem('soulframe_accountId');
        if (saved) setAccountId(saved);
      }, []);
      
      useEffect(() => {
        if (accountId) localStorage.setItem('soulframe_accountId', accountId);
      }, [accountId]);

      // Gestion du volume de la musique
      useEffect(() => {
        if (backgroundMusic) {
          backgroundMusic.volume = volume;
        }
        try {
          localStorage.setItem("soulframe_volume", String(volume));
        } catch {}
      }, [volume]);

      // Sauvegarde automatique des paramètres
      useEffect(() => {
        localStorage.setItem('soulframe_autoUpdate', JSON.stringify(autoUpdate));
      }, [autoUpdate]);

      // Synchronisation avec le module de statistiques
      useEffect(() => {
        if (payload && statsModule && statsModule.syncWithReactState) {
          statsModule.syncWithReactState(payload);
        }
      }, [payload, statsModule]);

      // Maintien des tags actifs
      useEffect(() => {
        const hasActiveTags = 
          Object.keys(weaponDiffs).length > 0 || 
          Object.keys(enemyDiffs).length > 0 || 
          Object.keys(statDiffs).length > 0;
        
        if (hasActiveTags && !hasChanges) {
          setHasChanges(true);
        }
        
        const interval = setInterval(() => {
          if (hasActiveTags && hasChanges) {
            setHasChanges(prev => !prev ? true : prev);
          }
        }, 1000);
        
        return () => clearInterval(interval);
      }, [weaponDiffs, enemyDiffs, statDiffs, hasChanges]);

      // Connexion du slider HTML au state React
      useEffect(() => {
        const slider = document.getElementById("musicVolume");
        if (!slider) return;

        slider.value = String(Math.round(volume * 100));

        const handleInput = (e) => {
          const val = parseFloat(e.target.value);
          if (!Number.isFinite(val)) return;
          const v = Math.min(Math.max(val / 100, 0), 1);
          setVolume(v);
        };

        slider.addEventListener("input", handleInput);
        slider.addEventListener("change", handleInput);

        return () => {
          slider.removeEventListener("input", handleInput);
          slider.removeEventListener("change", handleInput);
        };
      }, [volume]);

      // Gestion du zoom des images
      useEffect(() => {
        if (view !== "PS" || !payload) return;
        
        const container = document.getElementById("player-panel-root");
        if (!container) return;

        const initImageZoom = () => {
          let currentZoomed = null;
          let tooltip = null;

          function createTooltip() {
            tooltip = document.createElement('div');
            tooltip.className = 'image-zoom-tooltip';
            tooltip.style.cssText = `
              position: fixed;
              z-index: 999999;
              display: none;
              background: #0b0a08;
              border: 2px solid #d4af37;
              border-radius: 8px;
              padding: 12px;
              box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
              max-width: 320px;
              max-height: 350px;
              pointer-events: none;
              font-family: 'Merriweather', serif;
            `;
            document.body.appendChild(tooltip);
          }

          function getImageName(img) {
            let parent = img.parentElement;
            
            const flexContainer = img.closest('.flex.items-center.gap-3');
            if (flexContainer) {
              const nameElement = flexContainer.querySelector('.font-semibold.text-amber-50');
              if (nameElement) return nameElement.textContent.trim();
            }
            
            const tableRow = img.closest('tr');
            if (tableRow) {
              const nameCell = tableRow.querySelector('td:first-child .font-semibold');
              if (nameCell) return nameCell.textContent.trim();
            }
            
            const equipmentCard = img.closest('.relative.bg-\\[\\#0b0a08\\]');
            if (equipmentCard) {
              const titleElement = equipmentCard.querySelector('.text-sm.font-semibold');
              if (titleElement) return titleElement.textContent.trim();
            }
            
            if (img.alt && img.alt !== '') return img.alt;
            
            for (let i = 0; i < 3; i++) {
              if (!parent) break;
              const textElements = parent.querySelectorAll('.font-semibold, .text-amber-50, [class*="text-"]');
              for (let el of textElements) {
                const text = el.textContent.trim();
                if (text && text.length > 0 && text.length < 50) {
                  return text;
                }
              }
              parent = parent.parentElement;
            }
            
            return "Objet";
          }

                    function showTooltip(img, x, y) {
            if (!tooltip) createTooltip();
            
            const rect = img.getBoundingClientRect();
            const scale = 2.5;
            const imageName = getImageName(img);
            
            tooltip.innerHTML = '';
            
            // Titre de l'image (nom détecté)
            const nameElement = document.createElement('div');
            nameElement.style.cssText = `
              color: #fbbf24;
              font-weight: bold;
              font-size: 14px;
              margin-bottom: 8px;
              text-align: center;
              text-shadow: 0 0 4px rgba(0,0,0,0.9);
            `;
            nameElement.textContent = imageName;
            tooltip.appendChild(nameElement);
            
            // Image zoomée
            const zoomedImg = document.createElement('img');
            zoomedImg.src = img.src;
            zoomedImg.alt = img.alt;
            zoomedImg.style.cssText = `
              width: ${Math.min(rect.width * scale, 280)}px;
              height: ${Math.min(rect.height * scale, 280)}px;
              object-fit: contain;
              display: block;
              margin: 0 auto;
              border-radius: 4px;
            `;
            tooltip.appendChild(zoomedImg);
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Estimation de la taille du tooltip (image + texte + padding)
            const tooltipWidth = Math.min(rect.width * scale, 280) + 24;
            const tooltipHeight = Math.min(rect.height * scale, 280) + 60;
            
            // Position horizontale : à droite du curseur par défaut
            let left = x + 20;
            if (left + tooltipWidth > viewportWidth - 10) {
              // Si ça déborde à droite, on le met à gauche du curseur
              left = x - tooltipWidth - 20;
            }
            if (left < 10) {
              left = 10;
            }
            
            // Position verticale : au-dessus si on est dans la moitié basse de l'écran
            let top;
            if (y > viewportHeight / 2) {
              // Sous le milieu de l'écran → on met le tooltip au-dessus du curseur
              top = y - tooltipHeight - 20;
            } else {
              // Sinon, on le met en dessous du curseur
              top = y + 20;
            }
            
            // Clamp dans la fenêtre
            if (top < 10) {
              top = 10;
            }
            if (top + tooltipHeight > viewportHeight - 10) {
              top = viewportHeight - tooltipHeight - 10;
            }
            
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            tooltip.style.display = 'block';
            
            currentZoomed = img;
          }


          function hideTooltip() {
            if (tooltip) {
              tooltip.style.display = 'none';
            }
            currentZoomed = null;
          }

          function handleMouseMove(e) {
            if (currentZoomed && tooltip) {
              showTooltip(currentZoomed, e.clientX, e.clientY);
            }
          }

          function handleMouseEnter(img) {
            currentZoomed = img;
            const rect = img.getBoundingClientRect();
            showTooltip(img, rect.right, rect.top);
          }

          function handleMouseLeave() {
            hideTooltip();
          }

          const imageSelectors = [
            'img[src*="wikitide.net"]',
            'img[src*="githubusercontent"]',
            '.weapon-image-container img',
            '.enemy-image-container img', 
            '.boss-image-container img',
            'table img',
            '.flex.items-center.gap-3 img'
          ];

          imageSelectors.forEach(selector => {
            container.querySelectorAll(selector).forEach(img => {
              if (!img.classList.contains('zoomable-image')) {
                img.classList.add('zoomable-image');
                img.style.cursor = 'zoom-in';
                
                img.addEventListener('mouseenter', () => handleMouseEnter(img));
                img.addEventListener('mouseleave', handleMouseLeave);
                img.addEventListener('mousemove', handleMouseMove);
              }
            });
          });

          document.querySelectorAll('.image-zoom-tooltip').forEach(t => t.remove());
        };

        const timer = setTimeout(initImageZoom, 1000);
        return () => {
          clearTimeout(timer);
          document.querySelectorAll('.image-zoom-tooltip').forEach(t => t.remove());
        };
      }, [payload, activeTab, view]);

      // =============================================================================
      // FONCTIONS DE GESTION DES DONNÉES
      // =============================================================================

      // Réinitialiser les surbrillances
      const resetHighlights = () => {
        setWeaponDiffs({});
        setEnemyDiffs({});
        setStatDiffs({});
        setWeaponBonuses({});
        setEnemyBonuses({});
        setStatBonuses({});
        setHasChanges(false);
      };

      // Recalculer les différences
      const recomputeDiffs = () => {
        if (referenceData && payload) {
            const currentState = {
                weaponDiffs,
                enemyDiffs,
                statDiffs,
                weaponBonuses,
                enemyBonuses,
                statBonuses
            };
            
            const diffs = computeDiffs(referenceData, payload, currentState, currentState);
            
            setWeaponDiffs(diffs.weaponDiffs);
            setEnemyDiffs(diffs.enemyDiffs);
            setStatDiffs(diffs.statDiffs);
            setWeaponBonuses(diffs.weaponBonuses);
            setEnemyBonuses(diffs.enemyBonuses);
            setStatBonuses(diffs.statBonuses);
            setHasChanges(diffs.hasChanges);
        }
      };

      // Calculer les différences entre référence et données actuelles
      const computeDiffs = (referenceData, currentData, currentDiffs = {}, currentBonuses = {}) => {
        if (!referenceData || !currentData) {
          return {
            weaponDiffs: {},
            enemyDiffs: {},
            statDiffs: {},
            weaponBonuses: {},
            enemyBonuses: {},
            statBonuses: {},
            hasChanges: false,
          };
        }

        const refStats = referenceData?.Stats || {};
        const currentStats = currentData?.Stats || {};
        const refWeapons = refStats.Weapons || [];
        const currentWeapons = currentStats.Weapons || [];
        const refEnemies = refStats.Enemies || [];
        const currentEnemies = currentStats.Enemies || [];

        const existingWeaponDiffs = currentDiffs.weaponDiffs || {};
        const existingEnemyDiffs = currentDiffs.enemyDiffs || {};
        const existingStatDiffs = currentDiffs.statDiffs || {};
        const existingWeaponBonuses = currentBonuses.weaponBonuses || {};
        const existingEnemyBonuses = currentBonuses.enemyBonuses || {};
        const existingStatBonuses = currentBonuses.statBonuses || {};

        const weaponDiffs = {...existingWeaponDiffs};
        const enemyDiffs = {...existingEnemyDiffs};
        const statDiffs = {...existingStatDiffs};
        const weaponBonuses = {...existingWeaponBonuses};
        const enemyBonuses = {...existingEnemyBonuses};
        const statBonuses = {...existingStatBonuses};

        let hasChanges = false;
        const showGreenTags = statsModule?.greenTagsConfig?.display ?? true;

        // === DIFFÉRENCES DES ARMES ===
        currentWeapons.forEach((currentWeapon) => {
          const key = currentWeapon.type;
          if (!key) return;

          const refWeapon = refWeapons.find(w => w.type === key) || {};
          const diff = weaponDiffs[key] || {};
          const bonus = weaponBonuses[key] || {};

          // Kills
          const refKills = refWeapon.kills || 0;
          const currentKills = currentWeapon.kills || 0;
          const totalKillsDiff = currentKills - refKills;
          
          if (totalKillsDiff > 0  && showGreenTags) {
            diff.kills = true;
            bonus.kills = totalKillsDiff;
            hasChanges = true;
          }

          // Headshots
          const refHeadshots = refWeapon.headshots || 0;
          const currentHeadshots = currentWeapon.headshots || 0;
          const totalHeadshotsDiff = currentHeadshots - refHeadshots;
          if (totalHeadshotsDiff > 0  && showGreenTags) {
            diff.headshots = true;
            bonus.headshots = totalHeadshotsDiff;
            hasChanges = true;
          }

          // Assists
          const refAssists = refWeapon.assists || 0;
          const currentAssists = currentWeapon.assists || 0;
          const totalAssistsDiff = currentAssists - refAssists;
          if (totalAssistsDiff > 0  && showGreenTags) {
            diff.assists = true;
            bonus.assists = totalAssistsDiff;
            hasChanges = true;
          }

          // XP
          const refXP = refWeapon.xp || 0;
          const currentXP = currentWeapon.xp || 0;
          const totalXPDiff = currentXP - refXP;
          if (totalXPDiff > 0  && showGreenTags) {
            diff.xp = true;
            bonus.xp = totalXPDiff;
            hasChanges = true;
          }

          // Equip Time
          const refEquipTime = refWeapon.equipTime || 0;
          const currentEquipTime = currentWeapon.equipTime || 0;
          const totalEquipTimeDiff = currentEquipTime - refEquipTime;
          if (totalEquipTimeDiff > 0  && showGreenTags) {
            diff.equipTime = true;
            bonus.equipTime = totalEquipTimeDiff;
            hasChanges = true;
          }

          if (Object.keys(diff).length > 0) {
            weaponDiffs[key] = diff;
          }
          if (Object.keys(bonus).length > 0) {
            weaponBonuses[key] = bonus;
          }
        });

        // === DIFFÉRENCES DES ENNEMIS ===
        currentEnemies.forEach((currentEnemy) => {
          const key = currentEnemy.type;
          if (!key) return;

          const refEnemy = refEnemies.find(e => e.type === key) || {};
          const diff = enemyDiffs[key] || {};
          const bonus = enemyBonuses[key] || {};

          // Kills
          const refKills = refEnemy.kills || 0;
          const currentKills = currentEnemy.kills || 0;
          const totalKillsDiff = currentKills - refKills;
          
          if (totalKillsDiff > 0 && showGreenTags) {
            diff.kills = true;
            bonus.kills = totalKillsDiff;
            hasChanges = true;
          }

          // Headshots
          const refHeadshots = refEnemy.headshots || 0;
          const currentHeadshots = currentEnemy.headshots || 0;
          const totalHeadshotsDiff = currentHeadshots - refHeadshots;
          if (totalHeadshotsDiff > 0 && showGreenTags) {
            diff.headshots = true;
            bonus.headshots = totalHeadshotsDiff;
            hasChanges = true;
          }

          // Executions
          const refExecutions = refEnemy.executions || 0;
          const currentExecutions = currentEnemy.executions || 0;
          const totalExecutionsDiff = currentExecutions - refExecutions;
          if (totalExecutionsDiff > 0 && showGreenTags) {
            diff.executions = true;
            bonus.executions = totalExecutionsDiff;
            hasChanges = true;
          }

          // Deaths
          const refDeaths = refEnemy.deaths || 0;
          const currentDeaths = currentEnemy.deaths || 0;
          const totalDeathsDiff = currentDeaths - refDeaths;
          if (totalDeathsDiff > 0 && showGreenTags) {
            diff.deaths = true;
            bonus.deaths = totalDeathsDiff;
            hasChanges = true;
          }

          if (Object.keys(diff).length > 0) {
            enemyDiffs[key] = diff;
          }
          if (Object.keys(bonus).length > 0) {
            enemyBonuses[key] = bonus;
          }
        });

        // === DIFFÉRENCES DES STATISTIQUES GLOBALES ===
        // Time Played
        const refTimePlayed = refStats.TimePlayedSec || 0;
        const currentTimePlayed = currentStats.TimePlayedSec || 0;
        const totalTimePlayedDiff = currentTimePlayed - refTimePlayed;
        if (totalTimePlayedDiff > 0 && showGreenTags) {
          statDiffs.timePlayed = true;
          statBonuses.timePlayedSec = totalTimePlayedDiff;
          hasChanges = true;
        }

        // Pickup Count
        const refPickupCount = refStats.PickupCount || 0;
        const currentPickupCount = currentStats.PickupCount || 0;
        const totalPickupCountDiff = currentPickupCount - refPickupCount;
        if (totalPickupCountDiff > 0 && showGreenTags) {
          statDiffs.pickupCount = true;
          statBonuses.pickupCount = totalPickupCountDiff;
          hasChanges = true;
        }

        // Income
        const refIncome = refStats.Income || 0;
        const currentIncome = currentStats.Income || 0;
        const totalIncomeDiff = currentIncome - refIncome;
        if (totalIncomeDiff > 0 && showGreenTags) {
          statDiffs.income = true;
          statBonuses.income = totalIncomeDiff;
          hasChanges = true;
        }

        // Total Enemy Kills
        const refTotalEnemyKills = refEnemies.reduce((sum, enemy) => sum + (enemy.kills || 0), 0);
        const currentTotalEnemyKills = currentEnemies.reduce((sum, enemy) => sum + (enemy.kills || 0), 0);
        const totalEnemyKillsDiff = currentTotalEnemyKills - refTotalEnemyKills;
        if (totalEnemyKillsDiff > 0 && showGreenTags) {
          statDiffs.totalEnemyKills = true;
          statBonuses.totalEnemyKills = totalEnemyKillsDiff;
          hasChanges = true;
        }

        const hasActiveTags = 
          Object.keys(weaponDiffs).length > 0 || 
          Object.keys(enemyDiffs).length > 0 || 
          Object.keys(statDiffs).length > 0;

        return {
          weaponDiffs,
          enemyDiffs,
          statDiffs,
          weaponBonuses,
          enemyBonuses,
          statBonuses,
          hasChanges: hasChanges || hasActiveTags,
        };
      };

      // Définir une nouvelle référence
      const setReference = () => {
        if (payload) {
          resetHighlights();
          setReferenceData(payload);
          try {
            localStorage.setItem("soulframe_reference", JSON.stringify(payload));
          } catch (e) {}
        }
      };

      // Recalculer les diffs quand la configuration des tags verts change
      useEffect(() => {
        if (statsModule && referenceData && payload) {
            recomputeDiffs();
        }
      }, [statsModule?.greenTagsConfig?.display, referenceData, payload]);

      // Charger la référence depuis localStorage au démarrage
      useEffect(() => {
        try {
          const savedReference = localStorage.getItem('soulframe_reference');
          if (savedReference) {
            setReferenceData(JSON.parse(savedReference));
          }
        } catch (e) {}
      }, []);

      // =============================================================================
      // FONCTIONS D'APPEL API ET RAFRAÎCHISSEMENT
      // =============================================================================

      // Enregistre le compte côté backend (sans envoyer l'accountId)
      // Enregistre le compte côté backend (uniquement 1x par navigateur)
      function registerAccountFromPayload(json) {
        try {
          const r0 = json?.Results?.[0] || null;
          const accountName = r0?.DisplayName || null;

          const createdRaw = r0?.Created?.$date?.$numberLong || null;
          const accountCreated = createdRaw
            ? new Date(Number(createdRaw)).toISOString()
            : null;

          console.log("[REGISTER] candidate data (no ID sent)", {
            accountName,
            accountCreated,
          });

          if (!accountName) {
            console.log("[REGISTER] Skip register-account: missing accountName", {
              hasR0: !!r0,
            });
            return;
          }

          // --- Garde-fou : 1 seule requête par compte et par navigateur ---
          const storageKey =
            "soulframe_registered_" + accountName.toLowerCase();

          try {
            const already = localStorage.getItem(storageKey);
            if (already === "1") {
              console.log(
                "[REGISTER] Skip register-account: already registered in this browser",
                { accountName }
              );
              return;
            }
          } catch (e) {
            // Si localStorage plante (mode privé, etc.), on ignore et on continue
            console.warn("[REGISTER] localStorage not available, continuing anyway");
          }

          fetch("/api/register-account", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              accountName,
              accountCreated,
            }),
          })
            .then(async (res) => {
              if (!res.ok) {
                const text = await res.text();
                console.warn("[REGISTER] backend error", {
                  status: res.status,
                  text,
                });
                return;
              }

              console.log("[REGISTER] successfully sent to backend");

              // On marque le compte comme déjà enregistré
              try {
                localStorage.setItem(storageKey, "1");
              } catch (e) {
                // pas grave si ça échoue
              }
            })
            .catch((err) => {
              console.warn("Failed to register account:", err);
            });
        } catch (e) {
          console.warn("Error while trying to register account:", e);
        }
      }


      // Récupérer les données via l'API (bouton principal)
      async function fetchViaId(idOverride) {
        const id = idOverride || accountId;
        if (!id) return setError("Veuillez entrer un AccountId valide.");

        try {
          setIsUpdating(true);
          setError("");

          const url = `${PROXY}${encodeURIComponent(SOULFRAME_API + id)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          if (json?.error) throw new Error(json.error);

          // Envoi des infos de compte au backend pour logging
          registerAccountFromPayload(json);

          setUpdateMessage("✅ Données prêtes");

          setIsTransitioning(true);
          const T_START = 400;
          const T_SWITCH = 1200;
          const T_END = 2000;

          setTimeout(() => {
            setPayload(json);
            setView("PS");
            setActiveTab("player");
            if (backgroundMusic && !musicStarted) startBackgroundMusic();
          }, T_SWITCH);

          setTimeout(() => {
            setIsTransitioning(false);
          }, T_END);
        } catch (e) {
          setError(e?.message || String(e));
          setUpdateMessage("❌ Échec de la mise à jour");
          setTimeout(() => setUpdateMessage(""), 3000);
        } finally {
          setIsUpdating(false);
        }
      }

      // Rafraîchir les données (bouton Update + auto-update)
      const refreshData = async (mode = "manual") => {
        const currentAccountId = localStorage.getItem("soulframe_accountId");

        if (!currentAccountId) {
          if (mode === "auto") return;
          setError("Veuillez entrer un AccountId valide.");
          return;
        }

        try {
          setIsUpdating(true);
          if (mode !== "auto") setError("");

          const url = `${PROXY}${encodeURIComponent(
            SOULFRAME_API + currentAccountId
          )}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const json = await res.json();
          if (json?.error) throw new Error(json.error);

          // Pas d'appel registerAccountFromPayload ici :
          // on veut limiter les requêtes KV, l'enregistrement du compte
          // se fait seulement lors du premier chargement (fetchViaId).

          const oldPayloadForDiffs = payload;

          if (referenceData) {
            const currentState = {
              weaponDiffs,
              enemyDiffs,
              statDiffs,
              weaponBonuses,
              enemyBonuses,
              statBonuses,
            };

            const diffs = computeDiffs(
              referenceData,
              json,
              currentState,
              currentState
            );

            setWeaponDiffs(diffs.weaponDiffs);
            setEnemyDiffs(diffs.enemyDiffs);
            setStatDiffs(diffs.statDiffs);
            setWeaponBonuses(diffs.weaponBonuses);
            setEnemyBonuses(diffs.enemyBonuses);
            setStatBonuses(diffs.statBonuses);

            if (diffs.hasChanges) {
              setHasChanges(true);
              if (mode !== "auto") {
                setUpdateMessage("✅ Progrès depuis la référence");
              }
            } else {
              setHasChanges(false);
              if (mode !== "auto") {
                setUpdateMessage("✅ Données à jour (même que référence)");
              }
            }
          } else {
            setReferenceData(json);
            try {
              localStorage.setItem("soulframe_reference", JSON.stringify(json));
            } catch (e) {}

            setWeaponDiffs({});
            setEnemyDiffs({});
            setStatDiffs({});
            setWeaponBonuses({});
            setEnemyBonuses({});
            setStatBonuses({});
            setHasChanges(false);

            if (mode !== "auto") {
              setUpdateMessage("✅ Référence initialisée");
            }
          }

          // Mise à jour du module de statistiques
          if (statsModule) {
            if (typeof statsModule.handleManualUpdate === "function") {
              statsModule.handleManualUpdate(json, oldPayloadForDiffs || null);
            } else if (typeof statsModule.trackActivity === "function") {
              statsModule.trackActivity(json, oldPayloadForDiffs || null);
            }

            if (typeof statsModule.saveToStorage === "function") {
              statsModule.saveToStorage();
            }

            if (window.updateStatsUI) {
              window.updateStatsUI();
            }
          }

          setPayload(json);
          setView("PS");
          setActiveTab("player");
          if (backgroundMusic && !musicStarted) startBackgroundMusic();
        } catch (e) {
          setError(e?.message || String(e));
          if (mode !== "auto") {
            setUpdateMessage("❌ Échec de la mise à jour");
            setTimeout(() => setUpdateMessage(""), 3000);
          }
        } finally {
          setIsUpdating(false);
        }
      };

      // =============================================================================
      // FONCTIONS UTILITAIRES
      // =============================================================================

      // Exporter les données en CSV
      function downloadData() {
        if (!payload) return;

        const rows = [];

        // Player section
        rows.push(["Section", "Key", "Value"]);
        rows.push(["Player", "Account Name", playerInfo?.name ?? ""]);
        rows.push(["Player", "Mastery", playerInfo?.mastery ?? ""]);
        rows.push(["Player", "Account Created", playerInfo?.created ?? ""]);
        rows.push(["Player", "Time Played (h)", playerInfo?.timePlayedH ?? ""]);
        rows.push(["Player", "Items Collected", playerInfo?.pickupCount ?? ""]);
        rows.push(["Player", "Total Dracs", playerInfo?.income ?? ""]);
        rows.push([]);

        // Weapons
        rows.push([
          "Weapons",
          "Display Name",
          "Group",
          "Category",
          "Kills",
          "Headshots",
          "Assists",
          "XP",
          "EquipTime(sec)",
          "Raw type",
        ]);
        weapons.forEach((w) => {
          const display = getWeaponDisplayData(w.type);
          const cat = getWeaponCategory(w.type);
          rows.push([
            "Weapons",
            display.name,
            display.group,
            cat,
            w.kills || 0,
            w.headshots || 0,
            w.assists || 0,
            w.xp || 0,
            w.equipTime || 0,
            w.type || "",
          ]);
        });
        rows.push([]);

        // Enemies
        rows.push([
          "Enemies",
          "Id",
          "Display Name",
          "Faction",
          "Biome",
          "Kills",
          "Headshots",
          "Executions",
          "Deaths",
        ]);
        enrichedEnemies.forEach((e) => {
          rows.push([
            "Enemies",
            e.baseId || "",
            e.name || "",
            e.faction || "",
            e.biome || "",
            e.kills || 0,
            e.headshots || 0,
            e.executions || 0,
            e.deaths || 0,
          ]);
        });

        const csv = rows
          .map((row) =>
            row
              .map((v) =>
                `"${String(v ?? "")
                  .replace(/"/g, '""')
                  .trim()}"`
              )
              .join(",")
          )
          .join("\r\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "soulframe_tracker_data.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      window.SoulframeDownloadExcel = downloadData;

      // Charger le lore
      useEffect(() => {
        if (payload) return;
        let timer;
        (async () => {
          try {
            const resEN = await fetch(LORE_URL);
            let listEN = await resEN.json();
            if (Array.isArray(listEN)) {
              listEN = Array.from(new Set(listEN.map(s => (typeof s === "string" ? s.trim() : "")).filter(Boolean)));
            } else listEN = [];

            let listFR = [];
            try {
              const resFR = await fetch(LORE_URL.replace("lore.json", "lore_fr.json"));
              listFR = await resFR.json();
            } catch { }

            setLoreLines(listEN);
            setLoreLinesFR(listFR);
            setLoreIdx(Math.floor(Math.random() * listEN.length));
            timer = setInterval(() => setLoreIdx(p => (p + 1) % listEN.length), 20000);
          } catch { }
        })();
        return () => timer && clearInterval(timer);
      }, [payload]);

      // =============================================================================
      // CALCULS ET MÉMOISATION DES DONNÉES
      // =============================================================================

      // Extraction des données du payload
      const r0 = payload?.Results?.[0];
      const stats = payload?.Stats || {};
      const abilities = stats.Abilities || [];
      const enemies = stats.Enemies || [];
      const weapons = stats.Weapons || [];

      // Informations du joueur
      const playerInfo = useMemo(() => {
        if (!r0) return null;
        const created = r0?.Created?.$date?.$numberLong;
        const factions = r0?.Affiliations || [];
        const championFaction = factions.find(f => f.Tag === "ChampionSyndicate");
        const feyFaction = factions.find(f => f.Tag === "FeySyndicate");
        const silentRoseFaction = factions.find(f => f.Tag === "SilentRoseSyndicate");
        return {
          name: r0?.DisplayName,
          accountOid: r0?.AccountId?.$oid,
          created: created ? new Date(Number(created)).toLocaleDateString() : "—",
          mastery: stats?.PlayerLevel ?? "—",
          timePlayedH: stats?.TimePlayedSec ? (stats.TimePlayedSec / 3600).toFixed(1) + " h" : "—",
          migrated: r0?.MigratedToConsole ? "Yes" : "No",
          xp: stats?.XP ? stats.XP.toLocaleString() : "—",
          pickupCount: stats?.PickupCount ? stats.PickupCount.toLocaleString() : "—",
          income: stats?.Income ? stats.Income.toLocaleString() : "—",
          championStanding: championFaction?.Standing ?? 0,
          championTitle: championFaction?.Title ?? 0,
          feyStanding: feyFaction?.Standing ?? 0,
          feyTitle: feyFaction?.Title ?? 0,
          silentRoseStanding: silentRoseFaction?.Standing ?? 0,
          silentRoseTitle: silentRoseFaction?.Title ?? 0
        };
      }, [r0, stats]);

      // Capacités groupées par pacte
      const groupedAbilities = useMemo(() => {
        const groups = {};
        abilities.forEach(ab => {
          const key = ab.type?.split("/")?.pop();
          const meta = ABILITY_LABELS[key];
          if (!meta) return;
          if (!groups[meta.group]) groups[meta.group] = [];
          groups[meta.group].push({ name: meta.name, used: ab.used, icon: meta.icon });
        });
        return groups;
      }, [abilities]);

      // Ennemis groupés
      const groupedEnemies = useMemo(() => {
        const groups = {};
        groups.SUBBOSS = {
          name: SUBBOSS_CATEGORY.name,
          enemies: enemies.filter(e => SUBBOSS_CATEGORY.enemies.includes(e.type?.split("/")?.pop()))
        };
        Object.entries(ENEMY_CATEGORIES).forEach(([k, cat]) => {
          groups[k] = {
            name: cat.name,
            enemies: enemies.filter(e => cat.enemies.includes(e.type?.split("/")?.pop()))
          };
        });
        return groups;
      }, [enemies]);

      // Utilitaires pour les armes
      const getWeaponCategory = (weaponType) => {
        const key = weaponType?.split("/")?.pop();
        const data = WEAPON_NAMES[key];
        return data ? data.category : "unknown";
      };
      
      const getWeaponGroup = (weaponType) => {
        const key = weaponType?.split("/")?.pop();
        const data = WEAPON_NAMES[key];
        return data ? data.group : "Unknown";
      };
      
      const getWeaponDisplayData = (weaponType) => {
        const key = weaponType?.split("/")?.pop();
        const data = WEAPON_NAMES[key];
        return data ? { name: data.name, icon: data.icon, group: data.group } : { name: key || "Unknown Weapon", icon: "❓", group: "Unknown" };
      };

      // Armes groupées
      const groupedWeapons = useMemo(() => {
        const groups = { main: {}, secondary: {}, unknown: [] };
        weapons.forEach(w => {
          const category = getWeaponCategory(w.type);
          const group = getWeaponGroup(w.type);
          if (category === "unknown") {
            groups.unknown.push(w);
          } else {
            if (!groups[category][group]) groups[category][group] = [];
            groups[category][group].push(w);
          }
        });
        return groups;
      }, [weapons]);

      // Totaux de combat
      const totalStats = useMemo(() => {
        const totalKills = weapons.reduce((s, w) => s + (w.kills || 0), 0);
        const totalHeadshots = weapons.reduce((s, w) => s + (w.headshots || 0), 0);
        const totalEnemyKills = enemies.reduce((s, e) => s + (e.kills || 0), 0);
        return {
          totalKills, totalHeadshots, totalEnemyKills,
          headshotRatio: totalKills ? ((totalHeadshots / totalKills) * 100).toFixed(1) + "%" : "0%"
        };
      }, [weapons, enemies]);

      // Ennemis enrichis pour le compendium
      const enrichedEnemies = useMemo(
        () =>
          enemies.map((e) => {
            const fullKey = e.type?.split("/")?.pop() || "";
            const baseKey = fullKey.replace(/Avatar$/, "");
            const meta = ENEMY_COMPENDIUM[fullKey] || {};

            let displayName = meta.name || baseKey.replace(/([a-z])([A-Z])/g, "$1 $2").trim();
            if (ENEMY_RENAMES[baseKey]) {
              displayName = ENEMY_RENAMES[baseKey];
            }

            let faction = meta.faction || "Unknown";
            if (!faction) {
              if (baseKey.startsWith("Mockery")) {
                faction = "Mockery";
              } else if (baseKey === "SquidplantChild") {
                faction = "Hazards";
              } else if (baseKey === "BaliqShrimp" || baseKey === "BaliqShrimpGlades") {
                faction = "Corrupted";
              } else if (/Grunt/.test(baseKey)) {
                faction = "Ode";
              } else if (baseKey === "MendicantKnight") {
                faction = "Mendicant";
              }
            }

            let biome = meta.biome || "—";

            const eventTag = null;
            const isSpectre = false;

            return {
              ...e,
              id: fullKey,
              baseId: baseKey,
              name: displayName,
              faction,
              biome,
              category: meta.type || "Unknown",
              icon: meta.icon || null,
              eventTag,
              isSpectre
            };
          }),
        [enemies]
      );

      // Vue d'ensemble des ennemis
      const enemyOverview = useMemo(() => {
        if (!enrichedEnemies.length) {
          return {
            uniqueTypes: 0,
            killsByFaction: [],
            topFaction: null
          };
        }

        const typeSet = new Set();
        const killsByFactionMap = {};

        enrichedEnemies.forEach(e => {
          if (e.id) typeSet.add(e.id);
          const f = e.faction || "Unknown";
          const kills = e.kills || 0;
          killsByFactionMap[f] = (killsByFactionMap[f] || 0) + kills;
        });

        const killsByFaction = Object.entries(killsByFactionMap)
          .map(([faction, kills]) => ({ faction, kills }))
          .sort((a, b) => b.kills - a.kills);

        return {
          uniqueTypes: typeSet.size,
          killsByFaction,
          topFaction: killsByFaction[0] || null
        };
      }, [enrichedEnemies]);

      // Tri du compendium des ennemis
      const [enemySort, setEnemySort] = useState({
        key: "kills",
        direction: "desc"
      });

      const enemySortDefaults = {
        enemy: "asc",
        faction: "asc",
        biome: "asc",
        tags: "asc",
        kills: "desc",
        headshots: "desc",
        executions: "desc"
      };

      const handleEnemySortChange = (key) => {
        setEnemySort((prev) => {
          if (prev?.key === key) {
            return {
              key,
              direction: prev.direction === "asc" ? "desc" : "asc"
            };
          }
          return {
            key,
            direction: enemySortDefaults[key] || "asc"
          };
        });
      };

      // Tri des ennemis pour l'index
      const sortedEnrichedEnemies = useMemo(() => {
        const base = enrichedEnemies
          .filter((e) => !COMPENDIUM_EXCLUDED.has((e.baseId || e.id || "").replace(/Avatar$/, "")));

        const { key, direction } = enemySort || {};
        if (!key) return base;

        const dir = direction === "asc" ? 1 : -1;

        const getValue = (enemy) => {
          switch (key) {
            case "enemy":
              return enemy.name || "";
            case "faction":
              return enemy.faction || "";
            case "biome":
              return enemy.biome || "";
            case "tags": {
              const tags = [];
              if (enemy.category && enemy.category !== "Unknown") tags.push(enemy.category);
              if (enemy.eventTag) tags.push(enemy.eventTag);
              return tags.join(", ");
            }
            case "kills":
              return enemy.kills || 0;
            case "headshots":
              return enemy.headshots || 0;
            case "executions":
              return enemy.executions || 0;
            default:
              return 0;
          }
        };

        const hasEnemyDiff = (enemy) => {
          const d = enemyDiffs[enemy.type] || {};
          return d.kills || d.headshots || d.executions || d.deaths;
        };

        return [...base].sort((a, b) => {
          const da = hasEnemyDiff(a) ? 1 : 0;
          const db = hasEnemyDiff(b) ? 1 : 0;
          if (da !== db) return db - da;

          const va = getValue(a);
          const vb = getValue(b);

          if (typeof va === "number" && typeof vb === "number") {
            return (va - vb) * dir;
          }
          return String(va).localeCompare(String(vb)) * dir;
        });
      }, [enrichedEnemies, enemySort, enemyDiffs]);

      // Ennemis standards
      const standardEnemiesSorted = useMemo(
        () => sortedEnrichedEnemies.filter(e => !SUBBOSS_CATEGORY.enemies.includes(e.id)),
        [sortedEnrichedEnemies]
      );

      // Groupes par faction
      const factionGroups = useMemo(() => {
        const groups = {};
        standardEnemiesSorted.forEach(e => {
          const faction = e.faction || "Unknown";
          if (!groups[faction]) {
            groups[faction] = { enemies: [], totalKills: 0 };
          }
          groups[faction].enemies.push(e);
          groups[faction].totalKills += e.kills || 0;
        });
        return Object.entries(groups).sort(
          (a, b) => b[1].totalKills - a[1].totalKills
        );
      }, [standardEnemiesSorted]);

      // Nom d'affichage des sous-boss
      const getSubBossDisplayName = (enemyType) => {
        const key = enemyType?.split("/")?.pop();
        return SUBBOSS_CATEGORY.labels[key]?.name || key || "Unknown";
      };

      // Équipement favori
      const favoriteEquipment = useMemo(() => {
        if (!payload) return null;

        const pactUsage = {};
        Object.entries(groupedAbilities).forEach(([pact, arr]) => {
          pactUsage[pact] = arr.reduce((s, ab) => s + (ab.used || 0), 0);
        });
        const favoritePact = Object.entries(pactUsage).reduce((m, [p, u]) => (u > (m.usage || 0) ? { pact: p, usage: u } : m), {});

        const favMain = Object.values(groupedWeapons.main).flat().reduce((m, w) => {
          const t = w.equipTime || 0;
          return t > (m.equipTime || 0) ? { name: getWeaponDisplayData(w.type).name, equipTime: t } : m;
        }, {});

        const favSec = Object.values(groupedWeapons.secondary).flat().reduce((m, w) => {
          const t = w.equipTime || 0;
          return t > (m.equipTime || 0) ? { name: getWeaponDisplayData(w.type).name, equipTime: t } : m;
        }, {});

        const favSB = (groupedEnemies.SUBBOSS?.enemies || []).reduce((m, e) => {
          const k = e.kills || 0;
          return k > (m.kills || 0) ? { name: getSubBossDisplayName(e.type), kills: k } : m;
        }, {}) || { name: "Aucun", kills: 0 };

        return { favoritePact, favoriteMainWeapon: favMain, favoriteSecondaryWeapon: favSec, favoriteSubBoss: favSB };
      }, [payload, groupedAbilities, groupedWeapons, groupedEnemies]);

      // Helpers de formatage
      const formatXP = (xp) =>
        xp >= 1e6 ? (xp/1e6).toFixed(1)+'M' :
        xp >= 1e3 ? (xp/1e3).toFixed(1)+'K' :
        (xp||0).toLocaleString();

      const activeTabConf = useMemo(
        () => ongletsConfig.find(o => o.id === activeTab) || ongletsConfig[0],
        [activeTab]
      );

      // =============================================================================
      // FONCTIONS POUR LE SYSTÈME DE MOTES
      // =============================================================================

      // Persistance du score des motes
      useEffect(() => {
        localStorage.setItem("sf_mote_score", String(moteScore));
      }, [moteScore]);

      // Handler global pour les clics sur les motes
      useEffect(() => {
        window.__onMoteClick = handleMoteClick;
        return () => {
          window.__onMoteClick = null;
        };
      }, []);

      const handleMoteClick = () => {
        setMoteScore(prev => prev + 1);
      };

            // Système de rang pour les motes
      const getMoteRank = (score) => {
        // Version anglaise
        if (moteRankLang === "en") {
          if (score < 10) return "Mote-Lost Wanderer";
          if (score < 30) return "Glimmer Gatherer";
          if (score < 50) return "Mote Collector";
          if (score < 70) return "Mote Warden";
          if (score < 90) return "Glimmerweaver";
          if (score < 100) return "Mote Master";
          if (score < 125) return "Blossom Herald";
          if (score < 150) return "Mote Archon";
          return "Legend of the Preludes";
        }

        // Version française (par défaut)
        if (score < 10) return "Égaré des Motes";
        if (score < 30) return "Cueilleur de Lueurs";
        if (score < 50) return "Collecteur des Motes";
        if (score < 70) return "Gardien des Motes";
        if (score < 90) return "Tisseur de Lueurs";
        if (score < 100) return "Maître des Motes";
        if (score < 125) return "Héraut Florifère";
        if (score < 150) return "Archonte des Motes";
        return "Légende des PréLudes";
      };


      // =============================================================================
      // COMPOSANT DES STATISTIQUES
      // =============================================================================
      const StatisticsComponent = ({ statsModule }) => {
        const [refreshKey, setRefreshKey] = useState(0);
        const [currentTime, setCurrentTime] = useState(new Date());
        
        useEffect(() => {
          if (!statsModule) return;
          
          const interval = setInterval(() => {
            setCurrentTime(new Date());
            setRefreshKey(prev => prev + 1);
          }, 8000);
          
          return () => clearInterval(interval);
        }, [statsModule]);
        
        useEffect(() => {
          if (!statsModule) return;
          
          const originalSetPeriod = statsModule.setPeriod;
          const originalToggleSeriesVisibility = statsModule.toggleSeriesVisibility;
          const originalToggleGreenTagConfig = statsModule.toggleGreenTagConfig;
          const originalSetRefreshMode = statsModule.setRefreshMode;
          const originalTrackActivity = statsModule.trackActivity;
          const originalHandleManualRefresh = statsModule.handleManualRefresh;
          
          if (originalSetPeriod) {
            statsModule.setPeriod = function(period) {
              const result = originalSetPeriod.call(this, period);
              setRefreshKey(prev => prev + 1);
              return result;
            };
          }
          
          if (originalToggleSeriesVisibility) {
            statsModule.toggleSeriesVisibility = function(key) {
              const result = originalToggleSeriesVisibility.call(this, key);
              setRefreshKey(prev => prev + 1);
              return result;
            };
          }
          
          if (originalToggleGreenTagConfig) {
            statsModule.toggleGreenTagConfig = function(key, value) {
              const result = originalToggleGreenTagConfig.call(this, key, value);
              setRefreshKey(prev => prev + 1);
              return result;
            };
          }
          
          if (originalSetRefreshMode) {
            statsModule.setRefreshMode = function(mode) {
              const result = originalSetRefreshMode.call(this, mode);
              setRefreshKey(prev => prev + 1);
              return result;
            };
          }
          
          if (originalTrackActivity) {
            statsModule.trackActivity = function(newData, oldData) {
              const result = originalTrackActivity.call(this, newData, oldData);
              setRefreshKey(prev => prev + 1);
              return result;
            };
          }
          
          if (originalHandleManualRefresh) {
            statsModule.handleManualRefresh = function(newData) {
              const result = originalHandleManualRefresh.call(this, newData);
              setRefreshKey(prev => prev + 1);
              return result;
            };
          }
          
          return () => {
            if (statsModule) {
              statsModule.setPeriod = originalSetPeriod;
              statsModule.toggleSeriesVisibility = originalToggleSeriesVisibility;
              statsModule.toggleGreenTagConfig = originalToggleGreenTagConfig;
              statsModule.setRefreshMode = originalSetRefreshMode;
              statsModule.trackActivity = originalTrackActivity;
              statsModule.handleManualRefresh = originalHandleManualRefresh;
            }
          };
        }, [statsModule]);
        
        return (
          <div key={refreshKey}>
            {statsModule ? (
              <div
                dangerouslySetInnerHTML={{
                  __html: statsModule.renderStatisticsUI()
                }}
              />
            ) : (
              <div className='text-sm text-amber-200/80'>Loading statistics…</div>
            )}
          </div>
        );
      };

      // =============================================================================
      // RENDU PRINCIPAL
      // =============================================================================
      return (
        <div className="min-h-screen flex flex-col text-amber-100 font-[Merriweather] selection:bg-amber-500/20">

          {/* 🌫 Particules de fond */}
          <BackgroundParticles />
          
          {/* 🌼 Motes overlay global */}
          <WanderingMote count={1} />

          {/* Header sticky */}
          {payload && (
            <nav
              className="sticky top-0 z-50 backdrop-blur-md bg-[#12120f]/90 border-b border-amber-900/40 shadow-2xl shadow-amber-900/10"
              aria-label="Navigation principale"
            >
              <div className="max-w-7xl mx-auto px-4 py-4">
                <div className="grid grid-cols-[auto,1fr,auto] items-center">
                  
                  {/* Bouton Retour */}
                  <div className="flex items-center justify-start">
                    {view === "PS" && (
                      <button
                        type="button"
                        onClick={() => {
                          setView("PA");
                          setActiveTab("player");
                          window.scrollTo({ top: 0, behavior: "smooth" });
                        }}
                        className="focus:outline-none"
                      >
                        <img
                          src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/Retour.png"
                          alt="Retour"
                          className="
                            w-12 h-12
                            object-contain
                            drop-shadow-[0_0_12px_rgba(212,175,55,0.6)]
                            transition-all duration-300
                            hover:scale-105
                          "
                        />
                      </button>
                    )}
                  </div>

                  {/* Logo + titre */}
                  <div className="flex items-center gap-3 justify-self-center">
                    <div className="w-[72px] h-[72px] flex items-center justify-center rounded-lg overflow-hidden">
                      <img
                        src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/logoV1big.png"
                        alt="Soulframe Tracker Logo"
                        className="w-full h-full object-contain"
                      />
                    </div>
                  </div>

                  {/* Colonne droite vide */}
                  <div />
                </div>
              </div>
            </nav>
          )}

          {/* Toast de mise à jour */}
          {updateMessage && (
            <div className={`fixed top-20 left-1/2 -translate-x-1/2 ${updateMessage.includes("✅") ? "bg-green-900/90" : "bg-red-900/90"} text-amber-100 px-6 py-3 rounded-lg text-sm shadow-2xl transition-all duration-500 animate-fade-in-out z-50 border ${updateMessage.includes("✅") ? "border-green-700/50" : "border-red-700/50"}`} role="status" aria-live="polite">
              {updateMessage}
            </div>
          )}

          {/* Contenu principal */}
          <main className="flex-1 max-w-7xl mx-auto px-4 py-8">
            <div className="h-2 sm:h-0" />

            <div className="page-stack">
              {/* Erreur API */}
              {error && (
                <div className="mb-6 p-4 bg-red-900/20 border border-red-700/40 rounded-xl text-red-200 text-sm">
                  ❌ Erreur: {error}
                </div>
              )}

              {/* PAGE D'ACCUEIL */}
              <div
                className={`view ${view === "PA" ? "" : "hidden"}`}
                id="PA"
                aria-hidden={view !== "PA"}
              >
                {!error && (
                  <div className="text-center py-16 text-amber-300/70">
                    {/* Logo principal */}
                    <div className="flex justify-center mb-5">
                      <div className="w-[352px] h-[352px] flex items-center justify-center rounded-lg overflow-hidden">
                        <img
                          src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/logoV1big.png"
                          alt="Soulframe Tracker Logo"
                          className="w-full h-full object-contain"
                        />
                      </div>
                    </div>

                    {/* Logo texte */}
                    <div className="flex justify-center mb-8 mt-[-90px]">
                      <img
                        src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/Soulframe_Tracker_name.png"
                        alt="Soulframe Tracker"
                        className="w-[252px] h-[252px] object-contain"
                      />
                    </div>

                    {/* Zone de saisie AccountId */}
                    <div className="flex justify-center mb-8">
                      <div className="w-full max-w-2xl flex items-stretch gap-3">
                        <div className="flex-1">
                          <div className="rounded-xl border border-amber-700/40 bg-[#13120F]/90 shadow-2xl shadow-amber-900/10 overflow-hidden">
                            <div className="grid grid-cols-[1fr_auto] items-stretch">
                              <div className="relative">
                                  <input
                                   type="text"
                                   value={accountId}
                                   onChange={(e) => setAccountId(e.target.value)}
                                   placeholder="AccountId …"
                                   className="w-full h-14 pl-5 pr-5 bg-transparent outline-none text-amber-200 placeholder-amber-400/30"
                                   onKeyDown={(e) => e.key === "Enter" && fetchViaId()}
                                   onFocus={handleAccountIdFocus}
                                   aria-label="Saisir votre AccountId Soulframe"
                                 />

                              </div>
                              <button
                                onClick={() => fetchViaId()}
                                disabled={isUpdating}
                                className="h-14 px-8 font-semibold tracking-wide bg-[#12110E] hover:bg-[#12110E] text-amber-200 hover:text-amber-400 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Entrer"
                              >
                                {isUpdating ? "Loading…" : "Enter"}
                              </button>
                            </div>
                          </div>
                        </div>

                                               {/* Bouton d'aide AccountId → ouvre la popup dédiée */}
                        <div className="flex items-center">
                          <div className="inline-flex items-center gap-2 text-xs text-amber-300/80">
                            <button
                              type="button"
                              onClick={handleAccountHelpButtonClick}
                              aria-label="Comment trouver votre Account ID Soulframe ?"
                              aria-expanded={isAccountHelpOpen}
                              className={
                                "w-7 h-7 flex items-center justify-center rounded-full border bg-amber-900/60 hover:bg-amber-800/90 hover:shadow-[0_0_18px_rgba(251,191,36,0.8)] transition-all " +
                                (highlightHelpButton
                                  ? "border-amber-400 text-amber-50 shadow-[0_0_22px_rgba(251,191,36,0.9)] animate-pulse"
                                  : "border-amber-500/80 text-amber-200")
                              }
                            >
                              <span className="text-sm">?</span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Lore panneau */}
                    <div className="max-w-3xl mx-auto px-6 relative">
                      <button
                        onClick={() => setLanguage(language === "en" ? "fr" : "en")}
                        className="absolute top-3 right-4 text-xs text-amber-400/70 hover:text-amber-200 transition-colors bg-amber-900/20 border border-amber-800/40 px-2 py-1 rounded-md backdrop-blur-sm"
                        title={language === "en" ? "Afficher en français" : "Show in English"}
                      >
                        {language === "en" ? "FR" : "EN"}
                      </button>

                      <div className="bg-[#0f0f0e]/70 border border-amber-800/40 rounded-xl p-6 shadow-amber-900/10 shadow-2xl lore-panel">
                        <p
                          key={`${language}-${loreIdx}`}
                          className="lore-anim text-amber-200/90 text-lg sm:text-xl leading-relaxed tracking-wide break-words"
                        >
                          {language === "en"
                            ? loreLines[loreIdx] ?? "…"
                            : loreLinesFR[loreIdx] ?? loreLines[loreIdx] ?? "…"}
                        </p>
                      </div>

                      <div className="mt-3 text-xs text-amber-400/60">
                        <span>Credit: Avakot.org</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* PAGE STATS */}
              <div
                className={`view ${view === "PS" ? "" : "hidden"}`}
                id="PS"
                aria-hidden={view !== "PS"}
              >
                {/* Cadre principal */}
                <section id="player-panel-root" className="scroll-mt-24">
                  <div className="flex flex-col lg:flex-row gap-0 items-stretch mb-8 lg:-ml-20">
                    {/* Navigation verticale */}
                    <aside className="
                      w-full lg:w-40
                      flex-shrink-0
                      flex lg:flex-col
                      gap-2
                      mt-4
                      mb-4 lg:mb-0
                      lg:mt-20
                    ">
                      {ongletsConfig.map((tab) => {
                        const isActive = activeTab === tab.id;

                        return (
                          <button
                            key={tab.id}
                            type="button"
                            onClick={() => setActiveTab(tab.id)}
                            className={`
                              relative w-full lg:w-auto text-left
                              px-2 py-2 lg:px-3 lg:py-2
                              rounded-xl lg:rounded-l-2xl lg:rounded-r-none
                              border text-sm font-semibold tracking-wide
                              transition-all duration-200
                              shadow-[0_0_12px_rgba(0,0,0,0.6)]
                              ${
                                isActive
                                  ? "bg-[#1f1509] border-amber-400 text-amber-50 translate-x-0"
                                  : "bg-[#0f0b07]/90 border-amber-800/70 text-amber-200 hover:bg-[#17100a] hover:border-amber-400/70 hover:translate-x-[2px]"
                              }
                            `}
                          >
                            <span className="flex items-center gap-2">
                              <span className="uppercase tracking-[0.16em] text-xs text-amber-300/80">
                                {tab.id === "boss" ? "Boss" : tab.label}
                              </span>
                            </span>
                          </button>
                        );
                      })}
                    </aside>

                    {/* Colonne droite : actions + contenu */}
                    <div className="flex-1 flex flex-col gap-3">
                      {/* Barre d'actions */}
                      <div className="flex flex-wrap items-center justify-between gap-2">
                        {/* Groupe gauche : UPDATE + timer + Auto */}
                        <div className="flex gap-2 items-center">
                          <button
                            onClick={() => refreshData("manual")}
                            disabled={isUpdating || !payload}
                            className="
                              px-4 py-2
                              text-sm font-semibold
                              rounded-lg
                              bg-amber-900/40
                              border border-amber-700/70
                              text-amber-100
                              hover:bg-amber-800/70
                              hover:border-amber-500/80
                              disabled:opacity-50 disabled:cursor-not-allowed
                              transition-colors
                              flex items-center gap-3
                            "
                            title="Update"
                          >
                            <span>
                              {isUpdating ? "Updating…" : "Update"}
                            </span>

                            <span className="text-xs text-amber-300/80 border-l border-amber-700/60 pl-3">
                              <TimerDisplay statsModule={statsModule} />
                            </span>

                            <span
                              className={`
                                ml-2 text-[10px] px-2 py-0.5 rounded-full border
                                ${autoUpdate
                                  ? "bg-green-900/40 text-green-300 border-green-700/60"
                                  : "bg-gray-900/40 text-gray-300 border-gray-700/60"
                                }
                              `}
                            >
                              Auto: {autoUpdate ? "ON" : "OFF"}
                            </span>
                          </button>
                        </div>

                                      {/* MILIEU : Score de Motes + grade */}
                        <div className="flex-10 flex items-center justify-center gap-3">
                          <img 
                            src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/mote1.png"
                            alt="Mote"
                            className="w-6 h-6 object-contain"
                          />
                          <div className="leading-tight">
                            {/* Ligne score + switch FR/EN */}
                            <div className="flex items-center gap-2">
                              <div className="text-amber-200 font-semibold text-lg">
                                {moteScore}{" "}
                                {moteRankLang === "fr" ? "Motes collectées" : "Motes collected"}
                              </div>
                              <div className="inline-flex rounded-full border border-amber-600/70 bg-amber-900/40 text-[10px] overflow-hidden">
                                <button
                                  type="button"
                                  onClick={() => setMoteRankLang("fr")}
                                  className={
                                    "px-2 py-[1px] " +
                                    (moteRankLang === "fr"
                                      ? "bg-amber-500/80 text-black font-semibold"
                                      : "text-amber-200/80 hover:bg-amber-800/80")
                                  }
                                >
                                  FR
                                </button>
                                <button
                                  type="button"
                                  onClick={() => setMoteRankLang("en")}
                                  className={
                                    "px-2 py-[1px] " +
                                    (moteRankLang === "en"
                                      ? "bg-amber-500/80 text-black font-semibold"
                                      : "text-amber-200/80 hover:bg-amber-800/80")
                                  }
                                >
                                  EN
                                </button>
                              </div>
                            </div>

                            {/* Ligne rang */}
                            <div className="text-amber-400 text-sm">
                              {moteRankLang === "fr" ? "Grade" : "Rank"} :{" "}
                              {getMoteRank(moteScore)}
                            </div>
                          </div>
                        </div>


                        {/* Groupe droite : Set Reference + Tags ON/OFF */}
                        <div className="flex gap-2 items-center">
                          <button
                            onClick={setReference}
                            disabled={!payload}
                            className="
                              px-4 py-2
                              text-sm font-semibold
                              rounded-lg
                              bg-amber-900/40
                              border border-amber-700/70
                              text-amber-100
                              hover:bg-amber-800/70
                              hover:border-amber-500/80
                              disabled:opacity-50 disabled:cursor-not-allowed
                              transition-colors
                              flex items-center gap-3
                            "
                            title="Sets a new reference and resets the accumulated tags to zero."
                          >
                            <span>Set Reference</span>

                            <span
                              className={`
                                text-[10px] px-2 py-0.5 rounded-full border
                                ${statsModule?.greenTagsConfig?.display
                                  ? "bg-green-900/40 text-green-300 border-green-700/60"
                                  : "bg-red-900/40 text-red-300 border-red-700/60"
                                }
                              `}
                              title={
                                statsModule?.greenTagsConfig?.display
                                  ? "Green progression tags are VISIBLE (see Display Settings)."
                                  : "Green progression tags are HIDDEN (see Display Settings)."
                              }
                            >
                              {statsModule?.greenTagsConfig?.display ? "Tags 🟩" : "Tags 🟥"}
                            </span>
                          </button>
                        </div>
                      </div>
                    
                      {/* Conteneur principal */}
                      <div className="
                        relative
                        flex-1
                        bg-[#0b0a08]/90
                        border border-amber-700/70
                        rounded-2xl
                        shadow-[0_0_22px_rgba(0,0,0,0.85)]
                        p-6
                        backdrop-blur-sm
                        flex flex-col
                        min-h-[620px]
                      ">
                        <div className="absolute inset-1 rounded-2xl border border-amber-400/70 pointer-events-none" />

                        <div className="relative z-10">
                          <div className="mb-3 text-[11px] tracking-[0.26em] uppercase text-amber-400/80">
                            {(() => {
                              const current = ongletsConfig.find((o) => o.id === activeTab);
                              return current ? current.label.trim() : activeTab;
                            })()}
                          </div>

                          {/* Contenu dynamique */}
                          <section className="min-w-0">
                            <header className="mb-5 pb-3 border-b border-amber-800/50 flex items-center justify-between">
                              <h2 className="text-2xl font-serif text-amber-200 drop-shadow">
                                {activeTabConf.label}
                              </h2>
                            </header>

                            {/* CONTENU ONGLET PLAYER */}
                            {activeTab === "player" && (                              
                              <div className="space-y-8">
                                {/* MR + Account + mini stats */}
                                <div className="relative rounded-2xl overflow-hidden">
                                  <div className="relative z-10 p-4 sm:p-6 lg:p-7 flex flex-col gap-8">
                                    <div className="flex flex-col lg:flex-row gap-8 lg:gap-10 items-stretch">
                                      {/* Bloc MR + pseudo */}
                                      <div className="w-full lg:w-[420px]">
                                        <div className="
                                          relative
                                          bg-[#0b0a08]/90
                                          border border-amber-700/70
                                          rounded-xl
                                          shadow-[0_0_22px_rgba(0,0,0,0.85)]
                                          px-6 py-5
                                          flex items-center gap-6
                                        ">
                                          <div className="absolute inset-1 rounded-lg border-2 border-amber-400/70 pointer-events-none" />
                                          {/* Sphère MR */}
                                          <div
                                            className="relative flex items-center justify-center"
                                            style={{ width: "140px", height: "140px" }}
                                          >
                                            <img
                                              src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/Sphere_MR%20.png"
                                              alt="Mastery Rank"
                                              className="absolute inset-0 w-full h-full object-contain drop-shadow-[0_0_18px_rgba(212,175,55,0.45)] select-none pointer-events-none"
                                            />
                                            <span className="relative z-10 text-5xl font-bold text-amber-50 drop-shadow-[0_0_10px_rgba(0,0,0,0.95)] select-none">
                                              {playerInfo?.mastery ?? "—"}
                                            </span>
                                          </div>
                                          {/* Nom de compte + Account Created */}
                                          <div className="flex-1 flex flex-col">
                                           <div className="flex-1">
                                            <div className="text-[11px] tracking-[0.18em] uppercase text-amber-300/75 mb-1">
                                              Account Name
                                            </div>
                                            <div className="text-3xl font-serif font-bold text-amber-50 drop-shadow-[0_0_10px_rgba(0,0,0,0.9)] break-words">
                                              {playerInfo?.name ?? "—"}
                                            </div>
                                           </div>
      
                                           {/* Account Created en bas à droite */}
                                           <div className="mt-2 pt-2 border-t border-amber-800/40">
                                            <div className="flex justify-between items-center">
                                              <div className="text-[10px] tracking-[0.16em] uppercase text-amber-300/60">
                                               Account Created
                                              </div>
                                              <div className="text-xs text-amber-200/80 font-medium">
                                                {playerInfo?.created ?? "—"}
                                              </div>
                                             </div>
                                            </div>
                                           </div>
                                          </div>
                                         </div>
                                      {/* 4 mini-cards stats a droite dans player */}
                                      <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                                        <MiniStatCard
                                          label="TIME PLAYED"
                                          value={playerInfo?.timePlayedH ?? "—"}
                                          icon={
                                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                              <circle cx="12" cy="12" r="8" stroke="#CDAF55" strokeWidth="1.7" />
                                              <path
                                                d="M12 7v5l3 2"
                                                stroke="#E5D7A2"
                                                strokeWidth="1.6"
                                                strokeLinecap="round"
                                              />
                                            </svg>
                                          }
                                          highlight={!!statDiffs.timePlayed}
                                          badgeLabel={
                                            statBonuses.timePlayedSec
                                              ? `+${(statBonuses.timePlayedSec / 3600).toFixed(1)}h`
                                              : ""
                                          }
                                        />
                                        
                                        <MiniStatCard
                                          label="TOTAL ENEMY KILLS"
                                          value={totalStats.totalEnemyKills.toLocaleString()}
                                          icon="⚔️"
                                            highlight={!!statDiffs.totalEnemyKills}
                                              badgeLabel={
                                                statBonuses.totalEnemyKills
                                                ? `+${statBonuses.totalEnemyKills.toLocaleString()}`
                                                : ""
                                              }
                                         />

                                        <MiniStatCard
                                          label="ITEMS COLLECTED"
                                          value={playerInfo?.pickupCount ?? "—"}
                                          icon={
                                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                              <path
                                                d="M4 15l8-10 8 10H4z"
                                                stroke="#CDAF55"
                                                strokeWidth="1.7"
                                                strokeLinejoin="round"
                                              />
                                            </svg>
                                          }
                                          highlight={!!statDiffs.pickupCount}
                                          badgeLabel={
                                            statBonuses.pickupCount
                                              ? `+${statBonuses.pickupCount.toLocaleString()}`
                                              : ""
                                          }
                                        />

                                        <MiniStatCard
                                          label="TOTAL DRACS"
                                          value={playerInfo?.income ?? "—"}
                                          icon={
                                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                                              <circle cx="12" cy="12" r="8" stroke="#CDAF55" strokeWidth="1.7" />
                                              <path
                                                d="M8 12h8"
                                                stroke="#E5D7A2"
                                                strokeWidth="1.6"
                                                strokeLinecap="round"
                                              />
                                            </svg>
                                          }
                                          highlight={!!statDiffs.income}
                                          badgeLabel={
                                            statBonuses.income
                                              ? `+${statBonuses.income.toLocaleString()}`
                                              : ""
                                          }
                                        />
                                      </div>
                                    </div>

                                    {/* Factions Progress */}
                                    <div className="mt-2">
                                      <div className="
                                        relative
                                        bg-[#0b0a08]/90
                                        border border-amber-700/70
                                        rounded-xl
                                        shadow-[0_0_22px_rgba(0,0,0,0.85)]
                                        px-6 sm:px-8 py-5
                                      ">
                                        <div className="absolute inset-1 rounded-lg border-2 border-amber-400/70 pointer-events-none" />
                                        <div className="relative z-10">
                                          <div className="text-center mb-5">
                                            <span className="text-amber-200 text-lg font-semibold tracking-wide">
                                              Factions Progress
                                            </span>
                                          </div>
                                          <div className="space-y-5 text-xs sm:text-sm">
                                            {/* Kith of King */}
                                            <div>
                                              <div className="flex items-center justify-between mb-1">
                                                <span className="text-amber-200 flex items-center gap-2">
                                                  Kith of King
                                                  <span
                                                    className="w-2 h-2 rounded-full"
                                                    style={{ background: "#a83b3b" }}
                                                  ></span>
                                                </span>
                                                <span className="text-amber-300">
                                                  {(playerInfo?.championStanding ?? 0).toLocaleString()}
                                                </span>
                                              </div>
                                              <div className="h-2 rounded-full bg-[#2b2114] overflow-hidden">
                                                <div
                                                  className="h-full rounded-full"
                                                  style={{
                                                    width: `${Math.min(
                                                      ((playerInfo?.championStanding ?? 0) / 30000) * 100,
                                                      100
                                                    )}%`,
                                                    background: "linear-gradient(to right, #E1C172, #C7A053)"
                                                  }}
                                                ></div>
                                              </div>
                                            </div>

                                            {/* Alca Children */}
                                            <div>
                                              <div className="flex items-center justify-between mb-1">
                                                <span className="text-amber-200 flex items-center gap-2">
                                                  Alca Children
                                                  <span
                                                    className="w-2 h-2 rounded-full"
                                                    style={{ background: "#5e8b5e" }}
                                                  ></span>
                                                </span>
                                                <span className="text-amber-300">
                                                  {(playerInfo?.feyStanding ?? 0).toLocaleString()}
                                                </span>
                                              </div>
                                              <div className="h-2 rounded-full bg-[#2b2114] overflow-hidden">
                                                <div
                                                  className="h-full rounded-full"
                                                  style={{
                                                    width: `${Math.min(
                                                      ((playerInfo?.feyStanding ?? 0) / 30000) * 100,
                                                      100
                                                    )}%`,
                                                    background: "linear-gradient(to right, #E1C172, #C7A053)"
                                                  }}
                                                ></div>
                                              </div>
                                            </div>

                                            {/* The Silent Rose */}
                                            <div>
                                              <div className="flex items-center justify-between mb-1">
                                                <span className="text-amber-200 flex items-center gap-2">
                                                  The Silent Rose
                                                  <span
                                                    className="w-2 h-2 rounded-full"
                                                    style={{ background: "#4a6b9c" }}
                                                  ></span>
                                                </span>
                                                <span className="text-amber-300">
                                                  {(playerInfo?.silentRoseStanding ?? 0).toLocaleString()}
                                                </span>
                                              </div>
                                              <div className="h-2 rounded-full bg-[#2b2114] overflow-hidden">
                                                <div
                                                  className="h-full rounded-full"
                                                  style={{
                                                    width: `${Math.min(
                                                      ((playerInfo?.silentRoseStanding ?? 0) / 30000) * 100,
                                                      100
                                                    )}%`,
                                                    background: "linear-gradient(to right, #E1C172, #C7A053)"
                                                  }}
                                                ></div>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                {/* Favorite Equipment */}
                                {favoriteEquipment && (
                                  <div className="mt-4">
                                    <h3 className="text-lg font-semibold text-amber-200 mb-3">
                                      Favorite Equipment (based on time & kills)
                                    </h3>

                                    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
                                      {/* Favorite Pact */}
                                      <div className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl px-4 py-3 shadow-[0_0_16px_rgba(0,0,0,0.8)]">
                                        <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                        <div className="relative z-10 flex items-center gap-3">
                                          {favoriteEquipment.favoritePact?.pact && (
                                            <div className="w-10 h-10 flex items-center justify-center rounded-full bg-[#18140f] overflow-hidden">
                                              {PACT_ICONS[favoriteEquipment.favoritePact.pact] ? (
                                                <img
                                                  src={PACT_ICONS[favoriteEquipment.favoritePact.pact]}
                                                  alt={favoriteEquipment.favoritePact.pact}
                                                  className="w-9 h-9 object-contain"
                                                />
                                              ) : (
                                                <span className="text-xl">✨</span>
                                              )}
                                            </div>
                                          )}
                                          <div className="flex-1">
                                            <div className="text-[11px] tracking-[0.16em] uppercase text-amber-300/80">
                                              Favorite Pact
                                            </div>
                                            <div className="text-sm text-amber-50 font-semibold">
                                              {favoriteEquipment.favoritePact?.pact || "—"}
                                            </div>
                                            {favoriteEquipment.favoritePact?.usage ? (
                                              <div className="text-[11px] text-amber-300/80 mt-0.5">
                                                {favoriteEquipment.favoritePact.usage.toLocaleString()} casts
                                              </div>
                                            ) : null}
                                          </div>
                                        </div>
                                      </div>

                                      {/* Favorite Main Weapon */}
                                      <div className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl px-4 py-3 shadow-[0_0_16px_rgba(0,0,0,0.8)]">
                                        <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                        <div className="relative z-10">
                                          <div className="text-[11px] tracking-[0.16em] uppercase text-amber-300/80">
                                            Favorite Main Weapon
                                          </div>
                                          <div className="mt-1 text-sm text-amber-50 font-semibold break-words">
                                            {favoriteEquipment.favoriteMainWeapon?.name || "—"}
                                          </div>
                                          {favoriteEquipment.favoriteMainWeapon?.equipTime ? (
                                            <div className="text-[11px] text-amber-300/80 mt-0.5">
                                              {(favoriteEquipment.favoriteMainWeapon.equipTime / 3600).toFixed(1)}
                                              h equipped
                                            </div>
                                          ) : null}
                                        </div>
                                      </div>

                                      {/* Favorite Secondary Weapon */}
                                      <div className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl px-4 py-3 shadow-[0_0_16px_rgba(0,0,0,0.8)]">
                                        <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                        <div className="relative z-10">
                                          <div className="text-[11px] tracking-[0.16em] uppercase text-amber-300/80">
                                            Favorite Secondary
                                          </div>
                                          <div className="mt-1 text-sm text-amber-50 font-semibold break-words">
                                            {favoriteEquipment.favoriteSecondaryWeapon?.name || "—"}
                                          </div>
                                          {favoriteEquipment.favoriteSecondaryWeapon?.equipTime ? (
                                            <div className="text-[11px] text-amber-300/80 mt-0.5">
                                              {(
                                                favoriteEquipment.favoriteSecondaryWeapon.equipTime / 3600
                                              ).toFixed(1)}
                                              h equipped
                                            </div>
                                          ) : null}
                                        </div>
                                      </div>

                                      {/* Favorite SubBoss */}
                                      <div className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl px-4 py-3 shadow-[0_0_16px_rgba(0,0,0,0.8)]">
                                        <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                        <div className="relative z-10 flex items-center gap-3">
                                          <div className="w-10 h-10 flex items-center justify-center rounded-full bg-[#18140f]">
                                            <span className="text-lg">👑</span>
                                          </div>
                                          <div className="flex-1">
                                            <div className="text-[11px] tracking-[0.16em] uppercase text-amber-300/80">
                                                Most Killed Boss
                                            </div>
                                            <div className="text-sm text-amber-50 font-semibold">
                                              {favoriteEquipment.favoriteSubBoss?.name || "—"}
                                            </div>
                                            {favoriteEquipment.favoriteSubBoss?.kills ? (
                                              <div className="text-[11px] text-amber-300/80 mt-0.5">
                                                {favoriteEquipment.favoriteSubBoss.kills.toLocaleString()} kills
                                              </div>
                                            ) : null}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            )}

                            {/* CONTENU ONGLET BOSS */}
                            {activeTab === "boss" && (
                              <div className="space-y-6">
                                <p className="text-sm text-amber-200/90 mb-2">
                                  Overview of SubBoss encounters based on your recorded stats.
                                </p>

                                <DataTable
                                  headers={[
                                    "SubBoss",
                                    "Faction / Biome",
                                    "Kills",
                                    "Headshots",
                                    "Executions",
                                    "Deaths"
                                  ]}
                                  data={(groupedEnemies.SUBBOSS?.enemies || []).map((e) => {
                                    const typeKey = e.type;
                                    const simpleKey = typeKey?.split("/")?.pop();
                                    const enriched = enrichedEnemies.find((x) => x.id === simpleKey);
                                    const labelMeta = SUBBOSS_CATEGORY.labels[simpleKey] || {};
                                    const icon = labelMeta.icon || enriched?.icon || null;
                                    const diff = enemyDiffs[typeKey] || {};
                                    const bonus = enemyBonuses[typeKey] || {};

                                    return [
                                      <div className="flex items-center gap-3" key={typeKey}>
                                        {icon && (
                                          <div className="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0">
                                            <img
                                              src={icon}
                                              alt={getSubBossDisplayName(typeKey)}
                                              className="w-full h-full object-cover"
                                            />
                                          </div>
                                        )}
                                        <div>
                                          <div className="font-semibold text-amber-50 flex items-center gap-2">
                                            {getSubBossDisplayName(typeKey)}
                                          </div>
                                          <div className="text-[11px] text-amber-400/80">{simpleKey}</div>
                                        </div>
                                      </div>,
                                      <div className="text-sm text-amber-100">
                                        <div>{enriched?.faction || "Unknown"}</div>
                                        <div className="text-[11px] text-amber-400/80">
                                          {enriched?.biome || "—"}
                                        </div>
                                      </div>,
                                      <span
                                        className={diff.kills ? "text-emerald-300 font-semibold" : "text-amber-100"}
                                      >
                                        {(e.kills || 0).toLocaleString()}
                                        {bonus.kills && <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.kills}`}</span>}
                                      </span>,
                                      <span
                                        className={diff.headshots ? "text-emerald-300 font-semibold" : "text-amber-100"}
                                      >
                                        {(e.headshots || 0).toLocaleString()}
                                        {bonus.headshots && <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.headshots}`}</span>}
                                      </span>,
                                      <span
                                        className={diff.executions ? "text-emerald-300 font-semibold" : "text-amber-100"}
                                      >
                                        {(e.executions || 0).toLocaleString()}
                                        {bonus.executions && <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.executions}`}</span>}
                                      </span>,
                                      <span
                                        className={diff.deaths ? "text-red-300 font-semibold" : "text-amber-100"}
                                      >
                                        {(e.deaths || 0).toLocaleString()}
                                        {bonus.deaths && <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.deaths}`}</span>}
                                      </span>
                                    ];
                                  })}
                                  isBoss
                                />
                              </div>
                            )}

                            {/* CONTENU ONGLET ENEMIES */}
                            {activeTab === "enemies" && (
                              <div className="space-y-6">
                                {/* Overview mini stats */}
                                <div className="grid gap-4 sm:grid-cols-3">
                                  <MiniStatCard
                                    label="UNIQUE ENEMY TYPES"
                                    value={enemyOverview.uniqueTypes || 0}
                                    icon="📖"
                                    highlight={!!statDiffs.uniqueEnemyTypes}
                                    badgeLabel={
                                      statBonuses.uniqueEnemyTypes
                                        ? `+${statBonuses.uniqueEnemyTypes}`
                                        : ""
                                    }
                                  />
                                  <MiniStatCard
                                    label="TOP FACTION (KILLS)"
                                    value={
                                      enemyOverview.topFaction
                                        ? `${enemyOverview.topFaction.faction} (${enemyOverview.topFaction.kills.toLocaleString()})`
                                        : "—"
                                    }
                                    icon="🏳️"
                                  />
                                  <MiniStatCard
                                    label="TOTAL ENEMY KILLS"
                                    value={totalStats.totalEnemyKills.toLocaleString()}
                                    icon="⚔️"
                                    highlight={!!statDiffs.totalEnemyKills}
                                    badgeLabel={
                                      statBonuses.totalEnemyKills
                                        ? `+${statBonuses.totalEnemyKills.toLocaleString()}`
                                        : ""
                                    }
                                  />
                                </div>

                                {/* Enemy Index */}
                                <AccordionSection
                                  title="Enemy Index"
                                  subtitle="All enemies"
                                  isOpen={openEnemyPanel === "index"}
                                  onToggle={() =>
                                    setOpenEnemyPanel(openEnemyPanel === "index" ? "" : "index")
                                  }
                                >
                                  <DataTable
                                    headers={[
                                      { label: "Enemy", key: "enemy" },
                                      { label: "Faction", key: "faction" },
                                      { label: "Biome", key: "biome" },
                                      { label: "Tags", key: "tags" },
                                      { label: "Kills", key: "kills" },
                                      { label: "Headshots", key: "headshots" },
                                      { label: "Executions", key: "executions" }
                                    ]}
                                    data={sortedEnrichedEnemies
                                      .filter(
                                        (e) =>
                                          !COMPENDIUM_EXCLUDED.has(
                                            (e.baseId || e.id || "").replace(/Avatar$/, "")
                                          )
                                      )
                                      .map((e) => {
                                        const diff = enemyDiffs[e.type] || {};
                                        const bonus = enemyBonuses[e.type] || {};
                                        const tags = [];
                                        if (e.category && e.category !== "Unknown") tags.push(e.category);
                                        if (e.isSpectre) tags.push("Spectre");
                                        if (e.eventTag) tags.push(e.eventTag);
                                        const isSubBoss = SUBBOSS_CATEGORY.enemies.includes(e.id);

                                        return [
                                          <div className="flex items-center gap-3" key={e.id}>
                                            {e.icon && (
                                              <div className="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0">
                                                <img
                                                  src={e.icon}
                                                  alt={e.name}
                                                  className="w-full h-full object-cover"
                                                />
                                              </div>
                                            )}
                                            <div>
                                              <div className="font-semibold text-amber-50 flex items-center gap-2">
                                                {e.name}
                                                {isSubBoss && (
                                                  <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-900/60 border border-amber-600/70 text-amber-200">
                                                    SubBoss
                                                  </span>
                                                )}
                                               
                                              </div>
                                              <div className="text-[11px] text-amber-400/80">{e.baseId}</div>
                                            </div>
                                          </div>,
                                          e.faction || "Unknown",
                                          e.biome || "—",
                                          tags.length ? tags.join(", ") : "—",
                                          <span
                                            className={
                                              diff.kills
                                                ? "text-emerald-300 font-semibold"
                                                : "text-amber-100"
                                            }
                                          >
                                            {(e.kills || 0).toLocaleString()}
                                            {bonus.kills && (
                                              <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.kills.toLocaleString()}`}</span>
                                            )}
                                          </span>,
                                          <span
                                            className={
                                              diff.headshots
                                                ? "text-emerald-300 font-semibold"
                                                : "text-amber-100"
                                            }
                                          >
                                            {(e.headshots || 0).toLocaleString()}
                                            {bonus.headshots && (
                                              <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.headshots.toLocaleString()}`}</span>
                                            )}
                                          </span>,
                                          <span
                                            className={
                                              diff.executions
                                                ? "text-emerald-300 font-semibold"
                                                : "text-amber-100"
                                            }
                                          >
                                            {(e.executions || 0).toLocaleString()}
                                            {bonus.executions && (
                                              <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.executions.toLocaleString()}`}</span>
                                            )}
                                          </span>
                                        ];
                                      })}
                                    sortConfig={enemySort}
                                    onSortChange={handleEnemySortChange}
                                  />
                                </AccordionSection>

                                {/* Faction Index */}
                                <AccordionSection
                                  title="Faction Index"
                                  subtitle="Enemy types per faction."
                                  isOpen={openEnemyPanel === "faction"}
                                  onToggle={() =>
                                    setOpenEnemyPanel(openEnemyPanel === "faction" ? "" : "faction")
                                  }
                                >
                                  <DataTable
                                    headers={["Faction", "Unique enemy types", "Total kills"]}
                                    data={factionGroups.map(([faction, group]) => [
                                      faction,
                                      group.enemies.length,
                                      group.totalKills.toLocaleString()
                                    ])}
                                  />
                                </AccordionSection>
                              </div>
                            )}

                            {/* CONTENU ONGLET WEAPONS */}
                            {activeTab === "weapons" && (
                              <div className="space-y-8">
                                <p className="text-sm text-amber-200/90">
                                  Weapon stats are based on your usage time, kills, headshots and XP earned. Green
                                  values indicate recent progress since the last update.
                                </p>

                                {/* Main Weapons */}
                                <Card
                                  id="weapons-main"
                                  title="Main Weapons"
                                  defaultExpanded={true}
                                  className="mb-4"
                                >
                                  {(() => {
                                    const rows = [];

                                    // 1) On aplatit toutes les armes Main dans une seule liste
                                    const allMainWeapons = [];
                                    Object.entries(groupedWeapons.main).forEach(([groupName, list]) => {
                                      list.forEach((w) => {
                                        allMainWeapons.push({ ...w, groupName });
                                      });
                                    });

                                    // 2) On trie : taggées d'abord, puis par nom
                                    const sortedWeapons = allMainWeapons.sort((a, b) => {
                                      const diffA = weaponDiffs[a.type] || {};
                                      const diffB = weaponDiffs[b.type] || {};

                                      const taggedA = Object.keys(diffA).length > 0;
                                      const taggedB = Object.keys(diffB).length > 0;

                                      if (taggedA !== taggedB) {
                                        // armes avec tags verts en premier
                                        return taggedA ? -1 : 1;
                                      }

                                      const nameA = (getWeaponDisplayData(a.type).name || "").toLowerCase();
                                      const nameB = (getWeaponDisplayData(b.type).name || "").toLowerCase();
                                      return nameA.localeCompare(nameB);
                                    });

                                    // 3) On construit les lignes dans le *nouvel ordre*
                                    sortedWeapons.forEach((w) => {
                                      const display = getWeaponDisplayData(w.type);
                                      const diff = weaponDiffs[w.type] || {};
                                      const bonus = weaponBonuses[w.type] || {};
                                      const groupName = w.groupName;

                                      rows.push([
                                        <div className="flex items-center gap-3" key={w.type}>
                                          {display.icon && (
                                            <div className="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0">
                                              {typeof display.icon === "string" &&
                                              display.icon.startsWith("http") ? (
                                                <img
                                                  src={display.icon}
                                                  alt={display.name}
                                                  className="w-full h-full object-contain"
                                                />
                                              ) : (
                                                <span className="text-xl">{display.icon}</span>
                                              )}
                                            </div>
                                          )}
                                          <div>
                                            <div className="font-semibold text-amber-50">
                                              {display.name}
                                            </div>
                                            <div className="text-[11px] text-amber-400/80">
                                              {groupName}
                                            </div>
                                          </div>
                                        </div>,
                                        display.group,
                                        "Main",
                                        <span
                                          className={
                                            diff.kills
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {(w.kills || 0).toLocaleString()}
                                          {bonus.kills && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.kills.toLocaleString()}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.headshots
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {(w.headshots || 0).toLocaleString()}
                                          {bonus.headshots && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.headshots.toLocaleString()}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.assists
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {(w.assists || 0).toLocaleString()}
                                          {bonus.assists && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.assists.toLocaleString()}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.xp
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {formatXP(w.xp || 0)}
                                          {bonus.xp && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${formatXP(bonus.xp)}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.equipTime
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {((w.equipTime || 0) / 3600).toFixed(1)}h
                                          {bonus.equipTime && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${(
                                              bonus.equipTime / 3600
                                            ).toFixed(1)}h`}</span>
                                          )}
                                        </span>,
                                      ]);
                                    });

                                    return (
                                      <DataTable
                                        headers={[
                                          "Weapon",
                                          "Type",
                                          "Slot",
                                          "Kills",
                                          "Headshots",
                                          "Assists",
                                          "XP",
                                          "Time equipped",
                                        ]}
                                        data={rows}
                                      />
                                    );
                                  })()}
                                </Card>

                                {/* Secondary Weapons */}
                                <Card
                                  id="weapons-secondary"
                                  title="Secondary Weapons"
                                  defaultExpanded={true}
                                >
                                  {(() => {
                                    const rows = [];

                                    // 1) On aplatit toutes les armes Secondary en une seule liste
                                    const allSecondaryWeapons = [];
                                    Object.entries(groupedWeapons.secondary).forEach(([groupName, list]) => {
                                      list.forEach((w) => {
                                        allSecondaryWeapons.push({ ...w, groupName });
                                      });
                                    });

                                    // 2) On trie : armes taguées d'abord, puis par nom
                                    const sortedWeapons = allSecondaryWeapons.sort((a, b) => {
                                      const diffA = weaponDiffs[a.type] || {};
                                      const diffB = weaponDiffs[b.type] || {};

                                      const taggedA = Object.keys(diffA).length > 0;
                                      const taggedB = Object.keys(diffB).length > 0;

                                      if (taggedA !== taggedB) {
                                        // celles avec tags verts en premier
                                        return taggedA ? -1 : 1;
                                      }

                                      const nameA = (getWeaponDisplayData(a.type).name || "").toLowerCase();
                                      const nameB = (getWeaponDisplayData(b.type).name || "").toLowerCase();
                                      return nameA.localeCompare(nameB);
                                    });

                                    // 3) On remplit les lignes dans ce nouvel ordre
                                    sortedWeapons.forEach((w) => {
                                      const display = getWeaponDisplayData(w.type);
                                      const diff = weaponDiffs[w.type] || {};
                                      const bonus = weaponBonuses[w.type] || {};
                                      const groupName = w.groupName;

                                      rows.push([
                                        <div className="flex items-center gap-3" key={w.type}>
                                          {display.icon && (
                                            <div className="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0">
                                              {typeof display.icon === "string" &&
                                              display.icon.startsWith("http") ? (
                                                <img
                                                  src={display.icon}
                                                  alt={display.name}
                                                  className="w-full h-full object-contain"
                                                />
                                              ) : (
                                                <span className="text-xl">{display.icon}</span>
                                              )}
                                            </div>
                                          )}
                                          <div>
                                            <div className="font-semibold text-amber-50">
                                              {display.name}
                                            </div>
                                            <div className="text-[11px] text-amber-400/80">
                                              {groupName}
                                            </div>
                                          </div>
                                        </div>,
                                        display.group,
                                        "Secondary",
                                        <span
                                          className={
                                            diff.kills
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {(w.kills || 0).toLocaleString()}
                                          {bonus.kills && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.kills.toLocaleString()}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.headshots
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {(w.headshots || 0).toLocaleString()}
                                          {bonus.headshots && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.headshots.toLocaleString()}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.assists
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {(w.assists || 0).toLocaleString()}
                                          {bonus.assists && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${bonus.assists.toLocaleString()}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.xp
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {formatXP(w.xp || 0)}
                                          {bonus.xp && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${formatXP(bonus.xp)}`}</span>
                                          )}
                                        </span>,
                                        <span
                                          className={
                                            diff.equipTime
                                              ? "text-emerald-300 font-semibold"
                                              : "text-amber-100"
                                          }
                                        >
                                          {((w.equipTime || 0) / 3600).toFixed(1)}h
                                          {bonus.equipTime && (
                                            <span className="ml-1 text-[11px] px-1.5 py-0.5 rounded-full bg-emerald-900/40 text-emerald-300 border border-emerald-600/60 align-middle">{`+${(
                                              bonus.equipTime / 3600
                                            ).toFixed(1)}h`}</span>
                                          )}
                                        </span>,
                                      ]);
                                    });

                                    return (
                                      <DataTable
                                        headers={[
                                          "Weapon",
                                          "Type",
                                          "Slot",
                                          "Kills",
                                          "Headshots",
                                          "Assists",
                                          "XP",
                                          "Time equipped",
                                        ]}
                                        data={rows}
                                      />
                                    );
                                  })()}
                                </Card>
                              </div>
                            )}

                            {/* CONTENU ONGLET ABILITIES */}
                            {activeTab === "abilities" && (
                              <div className="space-y-6">
                                <p className="text-sm text-amber-200/90">
                                  Abilities are grouped by Pact. Usage counts are based on how many times each
                                  ability has been cast.
                                </p>

                                {GROUP_ORDER.map((groupName) => {
                                  const list = groupedAbilities[groupName];
                                  if (!list || !list.length) return null;
                                  return (
                                    <div
                                      key={groupName}
                                      className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl px-5 py-4 shadow-[0_0_18px_rgba(0,0,0,0.8)]"
                                    >
                                      <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                      <div className="relative z-10">
                                        <div className="flex items-center gap-3 mb-3">
                                          {PACT_ICONS[groupName] && (
                                            <div className="w-9 h-9 rounded-full overflow-hidden bg-[#18140f] flex items-center justify-center">
                                              <img
                                                src={PACT_ICONS[groupName]}
                                                alt={groupName}
                                                className="w-8 h-8 object-contain"
                                              />
                                            </div>
                                          )}
                                          <div>
                                            <div className="text-sm font-semibold text-amber-100">
                                              {groupName}
                                            </div>
                                            <div className="text-[11px] text-amber-400/80">
                                              {list.length} abilities
                                            </div>
                                          </div>
                                        </div>

                                        <div className="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
                                          {list.map((ab) => (
                                            <div
                                              key={ab.name}
                                              className="flex items-center gap-3 bg-[#12100d]/90 rounded-lg px-3 py-2 border border-amber-800/60"
                                            >
                                              <div className="w-8 h-8 rounded-lg bg-[#1b160f] flex items-center justify-center overflow-hidden flex-shrink-0">
                                                {typeof ab.icon === "string" && ab.icon.startsWith("http") ? (
                                                  <img
                                                    src={ab.icon}
                                                    alt={ab.name}
                                                    className="w-7 h-7 object-contain"
                                                  />
                                                ) : (
                                                  <span className="text-lg">{ab.icon}</span>
                                                )}
                                              </div>
                                              <div className="flex-1">
                                                <div className="text-sm text-amber-50 font-semibold">
                                                  {ab.name}
                                                </div>
                                                <div className="text-[11px] text-amber-300/80">
                                                  {ab.used.toLocaleString()} casts
                                                </div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            )}

                            {/* CONTENU ONGLET STATISTICS */}
                            {activeTab === "stats" && (
                              <div className="space-y-6">
                                <StatisticsComponent 
                                  statsModule={statsModule}
                                  key={activeTab}
                                />
                              </div>
                            )}

                            {/* CONTENU ONGLET SETTINGS */}
                            {activeTab === 'settings' && (
                              <div className="space-y-6">
                                {/* Section Auto-Update Settings */}
                                <div className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl p-6 shadow-[0_0_22px_rgba(0,0,0,0.85)]">
                                  <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                  <div className="relative z-10">
                                    <h3 className="text-lg font-semibold text-amber-200 mb-4">Auto-Update Settings</h3>
                                    
                                    <div className="flex items-center justify-between">
                                      <div>
                                        <div className="text-amber-100 font-medium">Automatic Updates</div>
                                        <div className="text-sm text-amber-200/80 mt-1">
                                          {autoUpdate 
                                            ? "Updates every 10 minutes" 
                                            : "Manual updates only"
                                          }
                                        </div>
                                      </div>
                                      
                                      <button
                                        onClick={() => setAutoUpdate(!autoUpdate)}
                                        className={`
                                          relative w-14 h-8 rounded-full transition-all duration-300
                                          ${autoUpdate 
                                            ? "bg-green-600" 
                                            : "bg-gray-600"
                                          }
                                        `}
                                      >
                                        <div
                                          className={`
                                            absolute top-1 w-6 h-6 bg-white rounded-full transition-all duration-300
                                            ${autoUpdate ? "left-7" : "left-1"}
                                          `}
                                        />
                                      </button>
                                    </div>
                                    
                                    <div className="mt-4 p-3 bg-amber-900/20 rounded-lg border border-amber-700/40">
                                      <div className="text-sm text-amber-200/90">
                                        <strong>Note:</strong> When enabled, your statistics will automatically update every 10 minutes while you're on the statistics page.
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                {/* Section Display Settings */}
                                <div className="relative bg-[#0b0a08]/90 border border-amber-700/70 rounded-xl p-6 shadow-[0_0_22px_rgba(0,0,0,0.85)]">
                                  <div className="absolute inset-1 rounded-lg border border-amber-400/70 pointer-events-none" />
                                  <div className="relative z-10">
                                    <h3 className="text-lg font-semibold text-amber-200 mb-4">Display Settings</h3>
                                    
                                    <div className="flex items-center justify-between">
                                      <div>
                                        <div className="text-amber-100 font-medium">Show green progression tags</div>
                                        <div className="text-sm text-amber-200/80 mt-1">
                                          {statsModule?.greenTagsConfig?.display 
                                            ? "Green tags visible" 
                                            : "Green tags hidden"
                                          }
                                        </div>
                                      </div>
                                      
                                      <button
                                        onClick={() => {
                                          if (statsModule) {
                                            const newValue = !statsModule.greenTagsConfig.display;
                                            
                                            // 1. Mettre à jour le module
                                            statsModule.toggleGreenTagConfig('display', newValue);
                                            
                                            // 2. Forcer le recalcul IMMÉDIAT des tags verts
                                            if (referenceData && payload) {
                                              const emptyState = {
                                                weaponDiffs: {}, enemyDiffs: {}, statDiffs: {},
                                                weaponBonuses: {}, enemyBonuses: {}, statBonuses: {}
                                              };
                                              
                                              const diffs = computeDiffs(referenceData, payload, emptyState, emptyState);
                                              
                                              setWeaponDiffs(diffs.weaponDiffs);
                                              setEnemyDiffs(diffs.enemyDiffs);
                                              setStatDiffs(diffs.statDiffs);
                                              setWeaponBonuses(diffs.weaponBonuses);
                                              setEnemyBonuses(diffs.enemyBonuses);
                                              setStatBonuses(diffs.statBonuses);
                                              setHasChanges(diffs.hasChanges);
                                            }
                                            
                                            // 3. Forcer le re-rendu du composant Settings
                                            setGreenTagsRefreshKey(prev => prev + 1);
                                          }
                                        }}
                                        className={`
                                          relative w-14 h-8 rounded-full transition-all duration-300
                                          ${statsModule?.greenTagsConfig?.display 
                                            ? 'bg-green-600' 
                                            : 'bg-gray-600'
                                          }
                                        `}
                                      >
                                        <div
                                          className={`
                                            absolute top-1 w-6 h-6 bg-white rounded-full transition-all duration-300
                                            ${statsModule?.greenTagsConfig?.display ? 'left-7' : 'left-1'}
                                          `}
                                        />
                                      </button>
                                    </div>
                                  </div>
                                </div>

                                {/* Section Data Management (depuis le module) */}
                                <div
                                  dangerouslySetInnerHTML={{
                                    __html: statsModule
                                      ? statsModule.renderSettingsUI()
                                      : "<div class='text-sm text-amber-200/80'>Loading settings…</div>"
                                  }}
                                />
                              </div>
                            )}
                          </section>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </main>

{/* Footer */}
<footer className="relative z-40 border-t border-amber-900/20 bg-[#0a0a08]/50 py-6 mt-12">
  <div className="max-w-7xl mx-auto px-4 text-amber-400/60 text-sm flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    
    {/* Texte existant à gauche */}
    <div className="text-center md:text-left">
      <p className="mb-1">
        Soulframe Data Tracker • Data retrieved from the official API
      </p>
      <div className="text-center md:text-left text-amber-500/40 text-xs">
        <p className="mb-2">
          Soulframe™ is a registered trademark of <strong>Digital Extremes Ltd.</strong><br />
          This site is a fan-made tracking tool and is not affiliated with Digital Extremes.<br />
          All rights to multimedia assets belong to their respective owners.
        </p>
      </div>
    </div>

    {/* Lien Soulframe Wiki FR à droite */}
    <a
      href="https://soulframe-guide.super.site/"
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center justify-center gap-3 mx-auto md:mx-0 text-amber-200 hover:text-amber-100 transition-transform duration-200 hover:scale-105"
    >
      <img
        src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/WikiFR.png"
        alt="Soulframe Wiki FR"
        className="w-10 h-10 object-contain rounded-lg border border-amber-500/60 shadow-[0_0_14px_rgba(0,0,0,0.75)] bg-black/40"
      />
      <span className="text-sm font-semibold">
        Soulframe Wiki FR
      </span>
    </a>
  </div>
</footer>
          {/* Voile de transition */}
          {isTransitioning && (
            <div className="transition-veil" aria-hidden="true">
              <div className="transition-logo">
                <img
                  src="https://raw.githubusercontent.com/generalshark/app-soulframe-v1/refs/heads/main/public/logoV1big.png"
                  alt=""
                />
              </div>
            </div>
          )}

          {/* Bouton & popup "What's new ?" */}
          <WhatsNewButton onOpen={() => setIsWhatsNewOpen(true)} />
          <WhatsNewModal
            open={isWhatsNewOpen}
            onClose={() => setIsWhatsNewOpen(false)}
            lang={patchLang}
            onChangeLang={setPatchLang}
          />
          {/* Popup d'aide pour l'AccountId */}
           <AccountIdHelpModal
             open={isAccountHelpOpen}
             onClose={() => setIsAccountHelpOpen(false)}
             lang={accountHelpLang}
             onChangeLang={setAccountHelpLang}
           />
        </div>
      );
    };

    // =============================================================================
    // INITIALISATION DE L'APPLICATION REACT
    // =============================================================================
    const rootElement = document.getElementById("root");
    if (rootElement) {
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);
    }
  </script>
</body>
</html>
